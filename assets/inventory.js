let inventoryPending=!1;var currentFetchedInventory=[],inventoryModeTotal=!1,displayInventoryPrice=!0;function loadInventoryPrices(){let e=document.querySelectorAll(nodeNames.hudItems);if(e.length>0&&!inventoryPending){let t=[],n=[];e.forEach(e=>{let r=e.querySelector(nodeNames.hudItemImage);if(r){if(r.complete){let i=calculateAverageColor(r);t.push(i),n.push(e)}else r.onload=function(){let i=calculateAverageColor(r);t.push(i),n.push(e)}}}),t.length>0&&(inventoryPending=!0,sendRequestByHash(t).then(e=>{console.log(e),setPricesInInventory(e,n),inventoryPending=!1}).catch(e=>{console.error(e),inventoryPending=!1}))}}function toggleInventoryStack(){return inventoryModeTotal=!inventoryModeTotal,loadInventoryPrices(),!0}function togglePrices(){displayInventoryPrice=!displayInventoryPrice;let e=document.querySelectorAll(".voxels-inventory-price");e.forEach(function(e){displayInventoryPrice?e.style.display="":e.style.display="none"});let t=document.querySelector(".voxels-inventory-total");return t&&(displayInventoryPrice?t.style.display="":t.style.display="none"),chrome.storage.local.set({displayInventoryPrice:displayInventoryPrice}),!0}function receiveInventory(e){if(e.source===window&&e.data.type&&"VOXELS_INV_DATA"===e.data.type){let t=e.data.data;checkAndUpdateInventory(t)}}window.addEventListener("message",receiveInventory);let currentInventory=[];function deepEqual(e,t){if(e===t)return!0;if("object"!=typeof e||"object"!=typeof t||null===e||null===t)return!1;let n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(let i of n)if(!r.includes(i)||!deepEqual(e[i],t[i]))return!1;return!0}function checkAndUpdateInventory(e){deepEqual(e,currentInventory)||(currentInventory=e,addTaskQuantities())}function setPricesInInventory(e,t){let n=0;function r(e){return e>9999?nFormatter(e,1):e}e.forEach((e,i)=>{let l=t[i];if(null!==e.price.price){let o=l.querySelector(".voxels-inventory-price"),a=e.price.price,c=l.querySelector(nodeNames.hudQuantities).textContent,s=c&&c.length>1?parseInt(c.substring(1),10):1,y=a*s;if(n+=y,inventoryModeTotal&&(a=y),o){o.innerText=r(a);let d=document.createElement("img");inventoryModeTotal?d.src=chrome.runtime.getURL("images/Prices/coin_total.png"):d.src=chrome.runtime.getURL("images/Prices/coin.png"),o.appendChild(d),o.classList.add("voxels-blinking"),setTimeout(()=>{o.classList.remove("voxels-blinking")},500)}else{var u=document.createElement("div");u.classList.add("voxels-inventory-price"),u.innerText=r(a);let v=document.createElement("img");inventoryModeTotal?v.src=chrome.runtime.getURL("images/Prices/coin_total.png"):v.src=chrome.runtime.getURL("images/Prices/coin.png"),u.appendChild(v),l.appendChild(u),u.classList.add("voxels-blinking"),setTimeout(()=>{u.classList.remove("voxels-blinking")},500)}}});let i=document.querySelector(nodeNames.hudSliding);var l=document.querySelector(".voxels-inventory-total");l||(l=document.createElement("div")),l.classList.add("voxels-inventory-total"),l.innerText=r(n);let o=document.createElement("img");if(o.src=chrome.runtime.getURL("images/Prices/coin_total.png"),l.appendChild(o),i.appendChild(l),!displayInventoryPrice){let a=document.querySelectorAll(".voxels-inventory-price");a.forEach(function(e){e.style.display="none"});let c=document.querySelector(".voxels-inventory-total");c&&(c.style.display="none")}}async function sendRequestByHash(e){return new Promise(async(t,n)=>{chrome.storage.local.get("user_info",async function(r){let i={name:r.user_info,operation:"fetchPricesByHash",extra:e};try{let l=await makeFetchRequest(apiURL,i),o=l.data,a=e.map((e,t)=>({averageColor:e,price:o[t]}));t(a)}catch(c){n(c)}})})}function calculateAverageColor(e){let t=document.createElement("canvas"),n=t.getContext("2d");t.width=e.width,t.height=e.height,n.drawImage(e,0,0,e.width,e.height);let r=n.getImageData(0,0,e.width,e.height).data,i=0,l=0,o=0;for(let a=0;a<r.length;a+=4)i+=r[a],l+=r[a+1],o+=r[a+2];let c=r.length/4,s=i/c,y=l/c,d=o/c,u=generateColorHash(s,y,d);return u}function generateColorHash(e,t,n){let r=`${Math.round(e)},${Math.round(t)},${Math.round(n)}`,i=0;for(let l=0;l<r.length;l++){let o=r.charCodeAt(l);i=(i<<5)-i+o}let a=(i>>>0).toString(16);return a}