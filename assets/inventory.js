let inventoryPending=!1;var currentFetchedInventory=[],inventoryModeTotal=!1,displayInventoryPrice=!0;function loadInventoryPrices(){let e=document.querySelectorAll(nodeNames.hudItems);if(e.length>0&&!inventoryPending){let t=[],n=[];e.forEach(e=>{let l=e.querySelector(nodeNames.hudItemImage);if(l){if(l.complete){let i=calculateAverageColor(l);t.push(i),n.push(e)}else l.onload=function(){let i=calculateAverageColor(l);t.push(i),n.push(e)}}}),t.length>0&&(inventoryPending=!0,sendRequestByHash(t).then(e=>{setPricesInInventory(e,n),inventoryPending=!1}).catch(e=>{console.error(e),inventoryPending=!1}))}}function toggleInventoryStack(){return inventoryModeTotal=!inventoryModeTotal,loadInventoryPrices(),!0}function togglePrices(){displayInventoryPrice=!displayInventoryPrice;let e=document.querySelectorAll(".voxels-inventory-price");e.forEach(function(e){displayInventoryPrice?e.style.display="":e.style.display="none"});let t=document.querySelector(".voxels-inventory-total");return t&&(displayInventoryPrice?t.style.display="":t.style.display="none"),chrome.storage.local.set({displayInventoryPrice:displayInventoryPrice}),!0}function receiveInventory(e){if(e.source===window&&e.data.type&&"VOXELS_INV_DATA"===e.data.type){let t=e.data.data;checkAndUpdateInventory(t)}}window.addEventListener("message",receiveInventory);let currentInventory=[];function deepEqual(e,t){if(e===t)return!0;if("object"!=typeof e||"object"!=typeof t||null===e||null===t)return!1;let n=Object.keys(e),l=Object.keys(t);if(n.length!==l.length)return!1;for(let i of n)if(!l.includes(i)||!deepEqual(e[i],t[i]))return!1;return!0}function checkAndUpdateInventory(e){deepEqual(e,currentInventory)||(currentInventory=e,addTaskQuantities())}function setPricesInInventory(e,t){let n=0;function l(e){return e>9999?nFormatter(e,1):e}e.forEach((e,i)=>{let r=t[i];if(null!==e.price.price){let o=r.querySelector(".voxels-inventory-price"),a=e.price.price,c=r.querySelector(nodeNames.hudQuantities).textContent,s=c&&c.length>1?parseInt(c.substring(1),10):1,d=a*s;if(n+=d,inventoryModeTotal&&(a=d),o){o.innerText=l(a);let u=document.createElement("img");inventoryModeTotal?u.src=chrome.runtime.getURL("images/Prices/coin_total.png"):u.src=chrome.runtime.getURL("images/Prices/coin.png"),o.appendChild(u),o.classList.add("voxels-blinking"),setTimeout(()=>{o.classList.remove("voxels-blinking")},500)}else{var y=document.createElement("div");y.classList.add("voxels-inventory-price"),y.innerText=l(a);let p=document.createElement("img");inventoryModeTotal?p.src=chrome.runtime.getURL("images/Prices/coin_total.png"):p.src=chrome.runtime.getURL("images/Prices/coin.png"),y.appendChild(p),r.appendChild(y),y.classList.add("voxels-blinking"),setTimeout(()=>{y.classList.remove("voxels-blinking")},500)}}});let i=document.querySelector(nodeNames.hudSliding);var r=document.querySelector(".voxels-inventory-total");r||(r=document.createElement("div")),r.classList.add("voxels-inventory-total"),r.innerText=l(n),inventoryValue=n;let o=document.createElement("img");if(o.src=chrome.runtime.getURL("images/Prices/coin_total.png"),r.appendChild(o),i.appendChild(r),!displayInventoryPrice){let a=document.querySelectorAll(".voxels-inventory-price");a.forEach(function(e){e.style.display="none"});let c=document.querySelector(".voxels-inventory-total");c&&(c.style.display="none")}}async function sendRequestByHash(e){return new Promise(async(t,n)=>{chrome.storage.local.get("user_info",async function(l){let i={name:l.user_info,operation:"fetchPricesByHash",extra:e};try{let r=await makeFetchRequest(apiURL,i),o=r.data,a=e.map((e,t)=>({averageColor:e,price:o[t]}));t(a)}catch(c){n(c)}})})}function calculateAverageColor(e){let t=document.createElement("canvas"),n=t.getContext("2d");t.width=e.width,t.height=e.height,n.drawImage(e,0,0,e.width,e.height);let l=n.getImageData(0,0,e.width,e.height).data,i=0,r=0,o=0;for(let a=0;a<l.length;a+=4)i+=l[a],r+=l[a+1],o+=l[a+2];let c=l.length/4,s=i/c,d=r/c,u=o/c,y=generateColorHash(s,d,u);return y}function calculateAverageBlueScore(e,t){let n=new Image;n.crossOrigin="Anonymous",n.src=e,n.onload=function(){let e=document.createElement("canvas"),l=e.getContext("2d");e.width=n.width,e.height=n.height,l.drawImage(n,0,0,n.width,n.height);let i=l.getImageData(0,0,n.width,n.height).data,r=0;for(let o=0;o<i.length;o+=4)r+=i[o+2];let a=i.length/4,c=r/a;t(c)},n.onerror=function(){t(!1)}}function generateColorHash(e,t,n){let l=`${Math.round(e)},${Math.round(t)},${Math.round(n)}`,i=0;for(let r=0;r<l.length;r++){let o=l.charCodeAt(r);i=(i<<5)-i+o}let a=(i>>>0).toString(16);return a}function observeTooltips(){let e=new MutationObserver(e=>{for(let t of e)"childList"===t.type&&t.addedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&"tooltip"===e.getAttribute("role")&&handleTooltip(e)})});e.observe(document.body,{childList:!0,subtree:!0})}function handleTooltip(e){let t=e.querySelector(".ItemStyles_tooltipTitle____kIs");if(t){let n=t.textContent.trim(),l=getItmByName(n);if(null!==l){let i=findRecipe(l);if(null!==i){let r=i.map(e=>e.id),o=mapItmToNameAndImage(r),a=e.querySelector(".MuiTooltip-tooltip");if(a){let c=a.querySelector(".voxels-tooltip-recipe-container");c&&c.remove();let s=document.createElement("div");s.classList.add("voxels-tooltip-recipe-container");let d=document.createElement("div");d.classList.add("voxels-tooltip-recipe-header"),d.textContent="Recipe",s.appendChild(d),o.forEach((e,t)=>{let n=i[t].quantity,l=document.createElement("div");l.classList.add("voxels-tooltip-recipe-item"),l.setAttribute("data-item-name",e.name);let r=document.createElement("img");r.src=e.image,r.alt=e.name,r.classList.add("voxels-tooltip-recipe-image");let o=document.createElement("div");o.classList.add("voxels-tooltip-recipe-count"),o.textContent=`x${n}`,l.appendChild(r),l.appendChild(o),s.appendChild(l)}),a.appendChild(s)}}}}}observeTooltips();