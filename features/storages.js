let mouseX=0,mouseY=0,isMobile=!1;function isMobileDevice(){return/Mobi|Android/i.test(navigator.userAgent)}isMobile=isMobileDevice(),document.addEventListener("mousemove",e=>{mouseX=e.clientX,mouseY=e.clientY});let currentStorageMid,currentCoinBalance=0,displayStorageHover=!0,firstLoadForPet=!0,uniqueItemNamesList=[],cachedStorages=null,previousPetInventory=null,cachedEntitiesMap=null,cachedStorageItemNames=[],cachedInventory=[],currentLocation,currentLand="",cameraData=null,cachedMixers=null;function handleEntityData(e){e.coinBalance!==currentCoinBalance&&e.coinBalance>0&&(currentCoinBalance=e.coinBalance),e.itemMixers&&(cachedMixers=e.itemMixers);let t=e.storages&&JSON.stringify(cachedStorages)!==JSON.stringify(e.storages);if(t){cachedStorages=e.storages;let i=e.location.match(/\d+/),n=i?i[0]:null;e.location.includes("speck")&&(n="speck"),(n&&autoUpdateLocations.includes(n)||e.location&&["PostOfficeInterior","DrunkenGooseInterior","mocaclub"].includes(e.location)&&autoUpdateLocations.includes(e.location))&&handleStorages(e.storages,e.location,!1)}if(e.petInventory&&JSON.stringify(e.petInventory)!==JSON.stringify(previousPetInventory)){previousPetInventory=JSON.parse(JSON.stringify(e.petInventory));let a=0;e.petInventory.items.forEach(e=>{let t=currentPricesList[e.itemName];if(t){let i=t*e.quantity;a+=i}}),petInventoryValue=a}let r=function e(t){let i=new Set;return t.storages?(cachedStorageItemNames=[],t.storages.forEach(e=>{e.items.forEach(e=>{i.add(e.itemName),cachedStorageItemNames.push(e.itemName)})})):cachedStorageItemNames.forEach(e=>{i.add(e)}),t.inventory&&t.inventory.items&&(t.inventory.items.forEach(e=>{i.add(e.item)}),JSON.stringify(cachedInventory)!==JSON.stringify(t.inventory.items)&&handleT4Data(cachedInventory=t.inventory.items,"inventory")),t.petInventory&&t.petInventory.items&&t.petInventory.items.forEach(e=>{i.add(e.itemName)}),Array.from(i)}(e),o=[...uniqueItemNamesList].sort(),s=[...r].sort();if(JSON.stringify(o)!==JSON.stringify(s)&&(uniqueItemNamesList=[...r]).length>0&&fetchItemListPrices(uniqueItemNamesList),!isMobile&&displayStorageHover&&function t(i){let n=document.querySelector(".voxels-extra-nodes"),a=document.querySelector(nodeNames.storageBox),r=document.querySelector("#voxels-main-modal");if(!n){console.error("Extra nodes container not found.");return}if(a||r&&r.matches(":hover")){let o=document.getElementById("voxels-storages-hover");o&&(o.remove(),currentStorageMid=0);return}if(i){let s,l=!1;if("pet"===i.id?(s=e.petInventory,l=!0):s=cachedStorages.find(e=>e.mid===i.id),s){if(currentStorageMid!==(l?"pet":s.mid)){currentStorageMid=l?"pet":s.mid;let d=document.getElementById("voxels-storages-hover");d||((d=document.createElement("div")).id="voxels-storages-hover",n.appendChild(d)),d.innerHTML="";let c=l?"Pet Inventory":`Chest Tier ${Math.ceil(s.size/6)}`,m=0,u=document.createElement("div");u.classList.add("voxels-storages-hover-header");let v=document.createElement("div");v.textContent=c;let g=document.createElement("div");g.classList.add("voxels-storages-hover-header-value"),g.textContent=m;let p=document.createElement("img");p.src=chrome.runtime.getURL("images/Prices/coin.png"),g.prepend(p),u.appendChild(v),u.appendChild(g),d.appendChild(u);let h=document.createElement("div");h.classList.add("voxels-storages-hover-content");let f=l?Math.min(s.size,6):6;for(let y=0;y<Math.ceil(s.size/f);y++)for(let x=0;x<f;x++){let E=document.createElement("div");E.classList.add("voxels-storages-hover-cell");let L=y*f+x,C=s.items.find(e=>e.position===L);if(C){let I=displayNamesJSONArray.find(e=>e.item===C.itemName);if(I){let S=document.createElement("img");S.src=I.image,S.alt=C.itemName,E.appendChild(S);let M=document.createElement("div");M.classList.add("voxels-storages-hover-quantity"),M.textContent=`x${C.quantity}`,E.appendChild(M);let $=currentPricesList[C.itemName];if($){let q=$*C.quantity;if(m+=q,displayInventoryPrice){let N=document.createElement("div");N.classList.add("voxels-inventory-price"),N.textContent=nFormatter(q,1),N.innerHTML+='<img src="'+chrome.runtime.getURL("images/Prices/coin.png")+'">',E.appendChild(N)}}}else{let X=document.createElement("img");X.src="https://pixels-api.com/images/item_not_found.png",X.alt="Item not identified",E.appendChild(X);let Y=document.createElement("div");Y.classList.add("voxels-storages-hover-quantity"),Y.textContent=`x${C.quantity}`,E.appendChild(Y)}}h.appendChild(E)}function B(e){let t=window.innerWidth,i=window.innerHeight,n=d.offsetWidth,a=d.offsetHeight,r=e.clientX,o=e.clientY;e.clientX+n>t&&(r=e.clientX-n),e.clientY+a>i&&(o=e.clientY-a),d.style.left=`${r}px`,d.style.top=`${o}px`}d.appendChild(h),g.innerHTML='<img src="'+chrome.runtime.getURL("images/Prices/coin.png")+'">'+nFormatter(m,3),B({clientX:mouseX,clientY:mouseY}),document.addEventListener("mousemove",B)}}else if(i.name===nodeNames.hover_node_01||i.name===nodeNames.hover_node_02){if(currentLandStorage&&currentStorageMid!==i.name){currentStorageMid=i.name;let H=currentLandStorage,P=document.getElementById("voxels-storages-hover");P||((P=document.createElement("div")).id="voxels-storages-hover",n.appendChild(P)),P.innerHTML="";let T=0,b=document.createElement("div");b.classList.add("voxels-storages-hover-header");let k=document.createElement("div");k.textContent="Land Surplus";let R=document.createElement("div");R.classList.add("voxels-storages-hover-header-value"),R.textContent=T;let U=document.createElement("img");U.src=chrome.runtime.getURL("images/Prices/coin.png"),R.prepend(U),b.appendChild(k),b.appendChild(R),P.appendChild(b);let _=document.createElement("div");_.classList.add("voxels-storages-hover-content");let z=Math.min(H.size,6);for(let D=0;D<Math.ceil(H.size/z);D++)for(let W=0;W<z;W++){let w=document.createElement("div");w.classList.add("voxels-storages-hover-cell");let A=D*z+W,F=H.items.find(e=>e.slot===A);if(F){let G=displayNamesJSONArray.find(e=>e.item===F.item);if(G){let O=document.createElement("img");O.src=G.image,O.alt=F.item,w.appendChild(O);let j=document.createElement("div");j.classList.add("voxels-storages-hover-quantity"),j.textContent=`x${F.quantity}`,w.appendChild(j);let J=marketPrices[F.item];if(J){let K=J*F.quantity;if(T+=K,displayInventoryPrice){let Q=document.createElement("div");Q.classList.add("voxels-inventory-price"),Q.textContent=nFormatter(K,1),Q.innerHTML+='<img src="'+chrome.runtime.getURL("images/Prices/coin.png")+'">',w.appendChild(Q)}}}else{let V=document.createElement("img");V.src="https://pixels-api.com/images/item_not_found.png",V.alt="Item not identified",w.appendChild(V);let Z=document.createElement("div");Z.classList.add("voxels-storages-hover-quantity"),Z.textContent=`x${F.quantity}`,w.appendChild(Z)}}_.appendChild(w)}function B(e){let t=window.innerWidth,i=window.innerHeight,n=P.offsetWidth,a=P.offsetHeight,r=e.clientX,o=e.clientY;e.clientX+n>t&&(r=e.clientX-n),e.clientY+a>i&&(o=e.clientY-a),P.style.left=`${r}px`,P.style.top=`${o}px`}P.appendChild(_),R.innerHTML='<img src="'+chrome.runtime.getURL("images/Prices/coin.png")+'">'+nFormatter(T,3),B({clientX:mouseX,clientY:mouseY}),document.addEventListener("mousemove",B)}}else{let ee=document.getElementById("voxels-storages-hover");ee&&(ee.remove(),currentStorageMid=0)}}else{let et=document.getElementById("voxels-storages-hover");et&&(et.remove(),currentStorageMid=0)}}(e.hoverNode),e.location){let l=e.location.match(/\d+/),d=l?l[0]:"";e.location.includes("speck")&&(d="speck"),currentLocation!==e.location&&(currentLand=d,currentLocation=e.location)}}function handleStorages(e,t,i){if(!t.includes("unknown")){let n={};e.forEach(e=>{e.items.forEach(e=>{n[e.itemName]?n[e.itemName]+=e.quantity:n[e.itemName]=e.quantity})});let a=Object.entries(n).map(([e,t])=>({item:e,count:t})),r=document.querySelector(nodeNames.hudTopLeft);r&&updateStoredItems(a,t,i)}}function updateStoredItems(e,t,i){chrome.storage.local.get("pid",async function(n){let a=n.pid;try{let r=await makeRequestToTools({pid:a,operation:"addStoredItems",extra:[{items:e},{location:t}]});r.data.status&&r.data.data.lands&&(handleT4Data(r.data.data.lands,"storages"),storedItemCache=r.data.data.lands),i&&(loadingScreen(0),r.data.status&&loadNetworth(0))}catch(o){console.error("Error updating entities:",o)}})}