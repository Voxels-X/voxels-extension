let msData=[],msContractData=[],contractRewards=[];function loadMSStats(){return new Promise(((e,t)=>{chrome.storage.local.get("pid",(async function(a){const n={pid:a.pid,operation:"getMSStats"};loadingScreen(1);try{const a=await makeFetchRequestByPID(apiURL,n);handleErrors(a)||("logout"==a?(initiate(),t("User logged out")):(loadingScreen(0),msData=a.data,chrome.storage.local.set({msstats:a.data.stats,msleaderboard:a.data.leaderboard}),e()))}catch(e){t(e)}}))}))}async function loadMSPage(){await loadMSStats(),reloadOverlay();const e=document.querySelector(".voxels-main"),t=await loadMSHeader();e.appendChild(t);let a=document.querySelector(".voxels-ms-container");a||(a=document.createElement("div"),a.classList.add("voxels-ms-container"),e.appendChild(a)),msContractData&&msContractData.length>0?updateMSContracts():displayPageInfo("Visit Harbormaster","Open your contracts page at the docks (South of Terravilla), to view your tasks here.")}function loadMSHeader(){return new Promise((e=>{chrome.storage.local.get("msstats",(function(t){const a=document.createElement("div");a.classList.add("voxels-ms-header-container");const n=document.createElement("div");n.classList.add("voxels-ms-header-top");const s=document.createElement("span");s.classList.add("voxels-ms-header-date");const o=new Date,d=new Date(Date.UTC(o.getUTCFullYear(),o.getUTCMonth(),o.getUTCDate()));s.innerHTML=d.toLocaleDateString(),n.appendChild(s);const i=document.createElement("div");i.classList.add("voxels-ms-header-reset");const c=()=>{const e=new Date,t=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate()+1,0,0,0))-e,a=String(Math.floor(t/36e5%24)).padStart(2,"0"),n=String(Math.floor(t/6e4%60)).padStart(2,"0"),s=String(Math.floor(t/1e3%60)).padStart(2,"0");i.innerHTML=`Reset: ${a}:${n}:${s}`};setInterval(c,1e3),c(),n.appendChild(i);const l=document.createElement("div");l.classList.add("voxels-ms-header-tokens");const r=document.createElement("img");r.src=chrome.runtime.getURL("images/Prices/voxels_buoy.png"),r.alt="Buoy Token",r.classList.add("voxels-buoy-icon");const m=document.createElement("span"),p=t.msstats?.extra?.buck??0;m.textContent=p,l.appendChild(r),l.appendChild(m),n.appendChild(l);const u=document.createElement("img");u.src=chrome.runtime.getURL("images/icons/icon__lb.svg"),u.alt="LB",u.classList.add("voxels-ms-header-stats-icon","clickable"),n.appendChild(u),u.addEventListener("click",(function(){premium?loadMSLeaderboard():showPremiumPopup("ms_leaderboard")})),a.appendChild(n);const h=document.createElement("div");h.classList.add("voxels-ms-header-bottom");const v=document.createElement("div");v.classList.add("voxels-ms-header-stats");const C=t.msstats?.weeklyStats??{},x=Object.keys(C).sort(((e,t)=>new Date(t)-new Date(e)));let g=0;!function e(t){const a=C[t]??{coinsSpent:0,deliveriesCompleted:0,xpEarned:0,pixelEarned:0,buoybuckEarned:0,itemsEarned:0},n=a.pixelEarned>0?Math.round(a.coinsSpent/a.pixelEarned):0,s=[{label:"Pixel earned",value:a.pixelEarned,icon:chrome.runtime.getURL("/images/Other/Pixel.png")},{label:"Coins spent",value:nFormatter(a.coinsSpent,2),icon:chrome.runtime.getURL("images/Prices/coin.png")},{label:"Coins/Pixel",value:nFormatter(n,2),icon:chrome.runtime.getURL("images/Prices/coin.png")},{label:"Delivered",value:a.deliveriesCompleted}];v.innerHTML="";const o=document.createElement("div");o.classList.add("voxels-ms-day-navigator");const d=document.createElement("button");d.textContent="◀",d.classList.add("clickable"),d.disabled=g>=x.length-1,d.onclick=()=>{g<x.length-1&&(g++,e(x[g]))};const i=document.createElement("button");i.textContent="▶",i.classList.add("clickable"),i.disabled=g<=0,i.onclick=()=>{g>0&&(g--,e(x[g]))};const c=document.createElement("div");c.textContent=function(e){const t=new Date(e);return`${t.toLocaleDateString(void 0,{weekday:"short"})} ${t.toLocaleDateString(void 0,{day:"2-digit",month:"2-digit"})}`}(t),c.classList.add("voxels-ms-date-label"),o.appendChild(d),o.appendChild(c),o.appendChild(i),v.appendChild(o),s.forEach((e=>{const t=document.createElement("div");t.classList.add("voxels-ms-header-stat-row");const a=document.createElement("div");a.classList.add("voxels-ms-header-stat-label"),a.textContent=e.label+":";const n=document.createElement("div");if(n.classList.add("voxels-ms-header-stat-value"),e.icon){const t=document.createElement("img");t.src=e.icon,t.alt="",t.classList.add("voxels-coin-icon"),n.appendChild(t)}const s=document.createElement("span");s.textContent=e.value,n.appendChild(s),t.appendChild(a),t.appendChild(n),v.appendChild(t)}));const l=document.createElement("div");l.classList.add("voxels-ms-header-stat-row","voxels-ms-header-stat-other");const r=document.createElement("div");r.classList.add("voxels-ms-header-stat-label"),r.textContent="Other:",l.appendChild(r);const m=document.createElement("div");m.classList.add("voxels-ms-header-stat-value","voxels-ms-header-stat-other-value");const p=(e,t,a,n="")=>{const s=document.createElement("div");s.classList.add("voxels-ms-gacha-box");const o=document.createElement("img");o.src=e,o.alt=t,o.classList.add("voxels-ms-gacha-icon"),s.appendChild(o);const d=document.createElement("div");d.classList.add("voxels-ms-gacha-text"),d.textContent=a,s.appendChild(d),m.appendChild(s)};a.buoybuckEarned>0&&p(chrome.runtime.getURL("images/Prices/voxels_buoy.png"),"Buoy Buck",`${a.buoybuckEarned}`),a.xpEarned>0&&p("https://d31ss916pli4td.cloudfront.net/game/ui/skills/skills_icon_business.png?v2","XP",nFormatter(a.xpEarned,2)),a.itemsEarned&&"object"==typeof a.itemsEarned&&Object.entries(a.itemsEarned).forEach((([e,t])=>{if(t>0){const a=displayNamesJSONArray.find((t=>t.item.startsWith(e)));a&&p(a.image,a.display_name,`${t}x`)}})),m.children.length>0&&(l.appendChild(m),v.appendChild(l))}(x[g]),h.appendChild(v);const L=document.createElement("div");L.classList.add("voxels-ms-header-graph");const f=document.createElement("div");f.innerHTML="7-day Graph",L.appendChild(f);const E=((e,t=185,a=120)=>{const n=document.createElement("div");n.classList.add("voxels-ms-header-graph-container");const s=document.createElement("canvas");s.width=t,s.height=a,n.appendChild(s);const o=e.map((e=>e.p)),d=e.map((e=>e.c)),i=e.map((e=>e.t)),c="#5ff600",l="#e3ff36",r="rgba(228, 255, 54, 0.1)";return new Chart(s,{type:"line",data:{labels:i,datasets:[{data:o,label:"Pixels Earned",borderColor:c,backgroundColor:"#5ff600",fill:!1,borderWidth:1.7,pointRadius:.3,tension:.4,yAxisID:"y1"},{data:d,label:"Coins Spent",borderColor:l,backgroundColor:"#e3ff36",fill:!1,borderWidth:1.7,pointRadius:.3,tension:.4,yAxisID:"y2"}]},options:{responsive:!1,interaction:{mode:"index",intersect:!1},animations:{duration:0},plugins:{legend:{display:!1},tooltip:{titleColor:"white",bodyColor:"white",backgroundColor:"black"}},scales:{x:{ticks:{font:{size:10},color:"#fff"},grid:{color:r}},y1:{position:"left",ticks:{font:{size:10},color:c,callback:e=>nFormatter(e,1)},beginAtZero:!1,grid:{color:r}},y2:{position:"right",ticks:{font:{size:10},color:l,callback:e=>nFormatter(e,1)},beginAtZero:!1,grid:{color:r}}}}}),n})([...x].sort(((e,t)=>new Date(e)-new Date(t))).map((e=>{const t=C[e],a=new Date(e);return{t:`${a.getDate()}/${a.getMonth()+1}`,p:t.pixelEarned,c:t.coinsSpent}})));L.appendChild(E),h.appendChild(L),a.appendChild(h),e(a)}))}))}function loadMSLeaderboard(){chrome.storage.local.get("msleaderboard",(function(e){const t=document.querySelector(".voxels-main");t.innerHTML="";const a=document.createElement("div");a.classList.add("voxels-ms-leaderboard-container");const n=document.createElement("div");n.classList.add("voxels-ms-leaderboard-topbar");const s=document.createElement("img");s.src=chrome.runtime.getURL("images/icons/icon__back-arrow.svg"),s.alt="Back",s.classList.add("voxels-ms-back-icon","clickable"),s.addEventListener("click",(function(){t.innerHTML="",loadMSPage()}));const o=document.createElement("div"),d=(new Date).toLocaleDateString(void 0,{timeZone:"UTC"});o.textContent=`Leaderboard - ${d}`,o.classList.add("voxels-ms-leaderboard-title"),n.appendChild(s),n.appendChild(o),a.appendChild(n);const i=e.msleaderboard;if(i&&0!==i.length){const e=document.createElement("div");e.classList.add("voxels-ms-leaderboard-list"),i.forEach(((t,a)=>{const n=document.createElement("div");n.classList.add("voxels-ms-leaderboard-row","clickable");const s=document.createElement("div");s.classList.add("voxels-ms-leaderboard-column","voxels-text-color-main"),s.textContent=`${a+1}.`,n.appendChild(s);const o=document.createElement("div");o.classList.add("voxels-ms-leaderboard-column","voxels-ms-leaderboard-username"),o.textContent=t.username,n.appendChild(o);const d=document.createElement("div");d.classList.add("voxels-ms-leaderboard-column","voxels-ms-leaderboard-pixels");const i=document.createElement("img");i.src=chrome.runtime.getURL("images/Other/Pixel.png"),i.classList.add("voxels-leaderboard-pixels-icon"),d.appendChild(i),d.append(`${t.pixelEarned.toLocaleString()}`),n.appendChild(d);const c=document.createElement("div");c.classList.add("voxels-ms-details-container"),c.style.display="none";const l=document.createElement("div");l.classList.add("voxels-ms-details-row"),l.innerHTML=`Deliveries: <span class="voxels-details-calc-number">${t.deliveriesCompleted}</span>`,c.appendChild(l);const r=document.createElement("div");r.classList.add("voxels-ms-details-row"),r.innerHTML=`Coins Spent: <span class="voxels-details-calc-number">${t.coinsSpent.toLocaleString()}</span>`,c.appendChild(r);const m=t.pixelEarned>0?t.coinsSpent/t.pixelEarned:0,p=document.createElement("div");p.classList.add("voxels-ms-details-row"),p.innerHTML=`Coins/Pixel: <span class="voxels-details-calc-number">${m.toFixed(2)}</span>`,c.appendChild(p);const u=document.createElement("div");u.classList.add("voxels-ms-details-row","voxels-details-button");const h=document.createElement("button");h.textContent="Profile page",h.addEventListener("click",(function(){loadPlayerPageTop(),loadPlayerPage(t.pid)})),u.appendChild(h),c.appendChild(u),n.addEventListener("click",(()=>{c.style.display="none"===c.style.display?"flex":"none"})),e.appendChild(n),e.appendChild(c)})),a.appendChild(e)}else{const e=document.createElement("div");e.textContent="Please wait for first stats.",e.classList.add("voxels-ms-no-data"),a.appendChild(e)}t.appendChild(a)}))}function updateMSContracts(){if(document.querySelector(".voxels-ms-container")&&msContractData.length>0){var e=document.querySelector(".voxels-ms-container");e.innerHTML="";const t=document.querySelector(".voxels-main-check");t&&t.remove();const a=document.createElement("div");a.classList.add("voxels-ms-table");const n=document.createElement("div");n.classList.add("voxels-ms-row","voxels-ms-table-header-row");const s=document.createElement("div");s.classList.add("voxels-ms-column"),s.innerHTML="Items";const o=document.createElement("div");o.classList.add("voxels-ms-column"),o.innerHTML="Cost";const d=document.createElement("div");d.classList.add("voxels-ms-column"),d.innerHTML="Rewards",n.appendChild(s),n.appendChild(o),n.appendChild(d),a.appendChild(n),msContractData.forEach((e=>{const t=document.createElement("div");if(t.classList.add("voxels-ms-row"),e.deliveredAt){const a=document.createElement("div");a.classList.add("voxels-ms-column","gif-column");const s=document.createElement("img");s.src=chrome.runtime.getURL("images/Animations/medium_ship.gif"),s.alt="Delivered",s.classList.add("voxels-ms-ship-gif"),a.appendChild(s);const o=contractRewards?.time?60*contractRewards.time*1e3:72e5,d=Date.now(),i=e.deliveredAt+o,c=d-e.deliveredAt,l=i-d,r=Math.min(c/o,1);s.style.left=94*r+"px",r<1?(s.style.transition=`left ${l}ms linear`,requestAnimationFrame((()=>{s.style.left="94px"}))):s.style.left="94px";const m=document.createElement("div");function n(e){const t=Math.max(0,Math.floor(e/1e3));return`${String(Math.floor(t/3600)).padStart(2,"0")}:${String(Math.floor(t%3600/60)).padStart(2,"0")}:${String(t%60).padStart(2,"0")}`}if(m.classList.add("voxels-ms-column","placeholder-column"),m.innerHTML=l>0?n(l):"Arrived",l>0){const e=setInterval((()=>{const t=Date.now(),a=i-t;a<=0?(m.innerHTML="Arrived",clearInterval(e)):m.innerHTML=n(a)}),1e3)}t.appendChild(a),t.appendChild(m)}else{let a=0;const n=document.createElement("div");n.classList.add("voxels-ms-column"),e.requestItems.forEach((e=>{const t=loadItemData(e.itemId),s=document.createElement("div");s.classList.add("voxels-ms-item","clickable");const o=document.createElement("img");o.src=t.imageSrc,o.alt=t.displayName,o.classList.add("voxels-ms-item-image");const d=document.createElement("div");d.classList.add("voxels-ms-item-text"),d.innerText=`${nFormatter(t.inventoryCount,1)}/${e.quantity}`,t.inventoryCount>=e.quantity&&d.classList.add("voxels-ms-item-fulfilled"),s.appendChild(o),s.appendChild(d),n.appendChild(s),a+=t.price*e.quantity,s.addEventListener("click",(function(e){if(premium&&e.shiftKey)changeTab("networth",t.displayName);else{var a=document.createElement("textarea");a.value=t.displayName,document.body.appendChild(a),a.select(),document.execCommand("copy"),document.body.removeChild(a);var n=document.querySelector(nodeNames.market_search);if(n)setNativeInputValue(n,t.displayName);else{var o=document.createElement("div");o.classList.add("voxels-hover-box"),o.textContent="Copied!",document.body.appendChild(o);var d=s.getBoundingClientRect();o.style.position="absolute",o.style.top=d.top-o.offsetHeight+"px",o.style.left=d.left+"px",setTimeout((function(){document.body.removeChild(o)}),2e3)}}})),s.addEventListener("mouseenter",(()=>{const a=document.createElement("div");a.classList.add("voxels-ms-hover");const n=document.createElement("div");n.classList.add("voxels-ms-hover-name"),n.textContent=t.displayName;const o=e.quantity*t.price,d=nFormatter(o,1),i=nFormatter(t.price,1),c=document.createElement("div");c.classList.add("voxels-ms-hover-price"),c.innerHTML=`${e.quantity} x ${i} = ${d}`;const l=document.createElement("img");if(l.src=chrome.runtime.getURL("images/Prices/coin.png"),l.classList.add("voxels-ms-price-icon"),c.innerHTML=`${e.quantity} x `,c.appendChild(l),c.innerHTML+=` ${i} = `,c.appendChild(l.cloneNode()),c.innerHTML+=` ${d}`,a.appendChild(n),a.appendChild(c),premium){storageCount=0;for(const t in storedItemCache)if(storedItemCache.hasOwnProperty(t)){const a=storedItemCache[t];for(const t in a)if(a.hasOwnProperty(t)){const n=a[t];if(n.items&&Array.isArray(n.items))for(const t of n.items)t.item===e.itemId&&(storageCount+=t.count)}}const t=document.createElement("div");t.classList.add("voxels-ms-hover-storage"),t.innerHTML=`<span>Storage:</span> ${storageCount} <span>(Shift + Click to Search)</span>`,a.appendChild(t)}const r=findRecipe(e.itemId);if(null!==r){const e=createRecipeContainer(r);a.appendChild(e)}const m=historic_item_prices(e.itemId);if(m){const t=document.createElement("div");t.classList.add("voxels-networth-hover-graph-container");const n=document.createElement("div");n.classList.add("voxels-networth-hover-graph-header"),n.textContent="7-day Graph",t.appendChild(n);let s=[...m];if(marketPrices[e.itemId]){const t=marketPrices[e.itemId],a=Math.floor(Date.now()/1e3);s.push({t:a,p:t})}const o=renderPriceChart(s);t.appendChild(o),a.appendChild(t)}document.body.appendChild(a);const p=s.getBoundingClientRect(),u=a.offsetWidth,h=a.offsetHeight;let v=p.left+p.width/2-u/2,C=p.top-h-5;const x=window.innerWidth;v<0&&(v=5),v+u>x&&(v=x-u),C<0&&(C=5),a.style.position="absolute",a.style.left=`${v}px`,a.style.top=`${C}px`,premium&&(currentItemHovered=e.itemId,itemHoverLoop())})),s.addEventListener("mouseleave",(()=>{document.querySelectorAll(".voxels-ms-hover").forEach((e=>{e.parentNode&&e.parentNode.removeChild(e)})),premium&&(currentItemHovered=null)}))}));const s=document.createElement("div");s.classList.add("voxels-ms-column");const o=document.createElement("img");o.src=chrome.runtime.getURL("images/Prices/coin.png"),o.classList.add("voxels-ms-coin-icon"),s.appendChild(o),s.innerHTML+=` ${nFormatter(a,2)}`,t.appendChild(n),t.appendChild(s)}const s=document.createElement("div");s.classList.add("voxels-ms-column");const o=document.createElement("div");o.classList.add("voxels-ms-item");const d=document.createElement("img");d.src=chrome.runtime.getURL("images/Prices/voxels_buoy.png"),d.alt="Buoy Image",d.classList.add("voxels-ms-item-image");const i=document.createElement("div");i.classList.add("voxels-ms-item-text");let c=contractRewards.buoy.mb_b1_reward;if(e.reward&&e.reward.gachaId){const t=e.reward.gachaId;contractRewards.buoy[t]&&(c=contractRewards.buoy[t])}i.innerText=c,o.appendChild(d),o.appendChild(i);const l=document.createElement("div");l.classList.add("voxels-ms-item");const r=e?.reward?.skill?.skillType||"business",m=e?.reward?.skill?.xp||"0",p=document.createElement("img");p.src=`https://d31ss916pli4td.cloudfront.net/game/ui/skills/skills_icon_${r}.png?v2`,p.alt="Skill",p.classList.add("voxels-ms-item-image");const u=document.createElement("div");u.classList.add("voxels-ms-item-text"),u.innerText=nFormatter(m,1),l.appendChild(p),l.appendChild(u);const h=document.createElement("div");h.classList.add("voxels-ms-item");const v=document.createElement("img");v.src=chrome.runtime.getURL("images/Other/Pixel.png"),v.alt="Pixel Image",v.classList.add("voxels-ms-item-image");const C=document.createElement("div");C.classList.add("voxels-ms-item-text");let x=contractRewards.pixels.mb_b1_reward;if(e.reward&&e.reward.gachaId){const t=e.reward.gachaId;contractRewards.pixels[t]&&(x=contractRewards.pixels[t])}C.innerText=x,h.appendChild(v),h.appendChild(C),s.appendChild(o),s.appendChild(l),s.appendChild(h),t.appendChild(s),a.appendChild(t)})),e.appendChild(a)}}function addMSPrices(e){if(!msContractData||0===msContractData.length)return;const t=document.querySelectorAll(nodeNames.msContainer);t&&0!==t.length&&msContractData.forEach(((a,n)=>{if(!contractRewards.costDisplayed||!0!==contractRewards.costDisplayed)return;let s=0;a.requestItems.forEach((e=>{const t=loadItemData(e.itemId);s+=t.price*e.quantity}));const o=nFormatter(s,1),d=t[n];if(!d)return;const i=d.querySelector(nodeNames.msHeaderTag);if(!i)return;const c=d.querySelector("h3");if(c){const e=c.querySelector("div");if(e&&"In Transit"===e.textContent.trim())return}const l=document.createElement("div");l.classList.add(e.replace(".","")),l.innerText="Total: "+o,i.parentNode.insertBefore(l,i)}))}function setupDeliveries(){document.querySelectorAll(nodeNames.msContainer).forEach(((e,t)=>{const a=e.querySelector(nodeNames.msFooter);if(a){const n=a.querySelector("button:not([disabled])");if(n&&!n.hasAttribute("data-listener-attached")){const a=n.textContent.toUpperCase();if(a.includes("FILL")){const a=e.querySelectorAll(nodeNames.msGachaPreview);if(a.length>=2){const e=a[contractRewards.rewardLocations[0]].innerText.trim(),n=a[contractRewards.rewardLocations[1]].innerText.trim();msContractData[t].calcRewards={buoyReward:e,pixelReward:n}}n.addEventListener("click",(function(){deliverContract(msContractData[t],t)}))}else a.includes("CLAIM")&&n.addEventListener("click",(function(){let e=msContractData[t];msClaimState.contractData=e,msClaimState.timeoutId&&clearTimeout(msClaimState.timeoutId),msClaimState.timeoutId=setTimeout((()=>{resetMSClaimState()}),1e4)}));n.setAttribute("data-listener-attached","true")}}}))}function deliverContract(e,t){const a=JSON.parse(JSON.stringify(e));let n=0;a.requestItems.forEach((e=>{const t=loadItemData(e.itemId);n+=t.price*e.quantity})),a.totalCost=n,chrome.storage.local.get("msDelivered",(function(e){let n=e.msDelivered||[];const s=Date.now();n=n.filter((e=>s-e.timestamp<=72e5));n.some((e=>e.index===t&&s-e.timestamp<=72e5))||(n.push({contract:a,timestamp:s,index:t}),chrome.storage.local.set({msDelivered:n}),chrome.storage.local.get("pid",(async function(e){const t={pid:e.pid,operation:"deliverContract",extra:a};try{await makeFetchRequestByPID(apiURL,t)}catch(e){}})))}))}const msClaimState={contractData:null,rewardData:null,timeoutId:null};function sendCombinedData(){const{contractData:e,rewardData:t}=msClaimState;chrome.storage.local.get("pid",(async function(a){const n={pid:a.pid,operation:"sendMSRewards",extra:{contract:e,reward:t}};try{await makeFetchRequestByPID(apiURL,n)}catch(e){}finally{resetMSClaimState()}}))}function resetMSClaimState(){msClaimState.contractData=null,msClaimState.rewardData=null,msClaimState.timeoutId&&(clearTimeout(msClaimState.timeoutId),msClaimState.timeoutId=null)}function storeMSContracts(){msContractData&&msContractData.length>0&&(chrome.storage.local.set({mscontracts:msContractData}),chrome.storage.local.get("pid",(async function(e){const t={pid:e.pid,operation:"saveContracts",extra:msContractData};try{await makeFetchRequestByPID(apiURL,t)}catch(e){}})))}