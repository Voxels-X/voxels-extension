function loadStats(){premium?loadStatsSetup():displayPremium()}function loadStatsSetup(){let e=document.querySelector(".voxels-main");var t=document.createElement("div");t.classList.add("voxels-main-stats","pixel-border");var a=document.createElement("div");a.classList.add("voxels-stats-header");var s=document.createElement("div");s.classList.add("voxels-stats-navigator");var l=document.createElement("div");l.classList.add("voxels-stats-nav-item","clickable","voxels-stats-active"),l.textContent="Stats";var i=document.createElement("div");i.classList.add("voxels-stats-nav-item","clickable"),i.textContent="Leaderboard";var n=document.createElement("div");n.classList.add("voxels-nav-divider"),s.appendChild(l),s.appendChild(n),s.appendChild(i),a.appendChild(s);var d=document.createElement("img");d.classList.add("voxels-stats-update"),d.src=chrome.runtime.getURL("/images/icons/icon__refresh.svg");let r=limiter(refreshStats,1e4);d.addEventListener("click",function(){r()}),a.appendChild(d),t.appendChild(a);var o=document.createElement("div");o.classList.add("voxels-stats-page"),t.appendChild(o),e.appendChild(t),l.addEventListener("click",function(){loadStatsPage("stats"),l.classList.add("voxels-stats-active"),i.classList.remove("voxels-stats-active")}),i.addEventListener("click",function(){loadStatsPage("leaderboard"),l.classList.remove("voxels-stats-active"),i.classList.add("voxels-stats-active")}),refreshStats()}function refreshStats(){chrome.storage.local.get("pid",async function(e){let t=e.pid;loadingScreen(1);try{let a=await makeFetchRequest(apiURL,{pid:t,operation:"getPlayerStats"});if(!handleErrors(a)){if("logout"==a)initiate();else{loadingScreen(0);let s=document.querySelector(".voxels-stats-nav-item.voxels-stats-active");chrome.storage.local.set({stats:a.data},function(){loadStatsPage(s.textContent.toLowerCase())})}}}catch(l){console.error(l)}})}function loadStatsPage(e){chrome.storage.local.get(["stats","user_info"],function(t){clearStatsPage();let a=document.querySelector(".voxels-stats-page"),s=t.user_info;var l=new Date,i=l.getUTCDate()+"/"+(l.getUTCMonth()+1)+"/"+l.getUTCFullYear();if("stats"===e){userStats=t.stats.stats;let n=userStats.per_day,d=userStats.extra,r=userStats.skill_data,o=userStats.individual_tasks,c=userStats.task_timestamp,p=document.createElement("div");p.classList.add("voxels-stats-basics");let v=document.createElement("div");if(v.classList.add("voxels-stats-name","clickable"),"world"in d?v.innerHTML=`${d.username} <span>- World</span> ${d.world}`:v.innerHTML=`${d.username} <span>- Offline</span>`,p.appendChild(v),v.addEventListener("click",function(){loadPlayerPageTop(),loadPlayerPage(d.PID)}),"vip"in d){let m=document.createElement("div");m.classList.add("voxels-stats-field");let x=new Date(d.vip),g=x.toLocaleString();m.innerHTML=`<span>VIP: expires</span> ${g}`,p.appendChild(m)}let h=document.createElement("div");h.classList.add("voxels-stats-field");let u=d.pixels,L=d.total_value_usd.toFixed(2),C=(L/u).toFixed(2);h.innerHTML="<span>Pixels: </span>"+u+" <img src='"+chrome.runtime.getURL("images/Other/Pixel.png")+"'><span> = "+L+"$</span> (1 <img src='"+chrome.runtime.getURL("images/Other/Pixel.png")+"'> = ~"+C+"$)",p.appendChild(h);let k=document.createElement("div");k.classList.add("voxels-stats-field");let f=d.level;k.innerHTML="<span>Overall level: </span>"+f,p.appendChild(k),data=statsCalculations(n);let E=document.createElement("div");E.classList.add("voxels-stats-earnings");let b=new Date,$=b.toISOString().split("T")[0],y=b.getUTCDate(),w=b.getUTCMonth()+1,P=y+"/"+w,T,M,I,S,_=0;for(var H=0;H<n.length;H++)n[H].date===$&&(T=data[H].pixels_made,M=data[H].coins_total,I=data[H].c_p_ratio.toFixed(2),S=data[H].tasks_done,_=data[H].pixel_tasks);E.innerHTML="Earnings <span>("+P+")</span>";let U=["Pixels made","Coins spent","Coins spent per pixel","Tasks done","Pixel tasks"],O=[T,M,I,S,_],R=[`<img src="${chrome.runtime.getURL("images/Other/Pixel.png")}">`,`<img src="${chrome.runtime.getURL("images/Prices/coin.png")}">`,`<img src="${chrome.runtime.getURL("images/Prices/coin.png")}">`,"",""];for(let B=0;B<U.length;B++){let V=document.createElement("div");V.classList.add("voxels-stats-field");let D="Pixels made"===U[B]||"Coins spent"===U[B]||"Coins spent per pixel"===U[B]?R[B]+" ":"";V.innerHTML=`<span>${U[B]}:</span> ${D}${O[B]}`,E.appendChild(V)}if(p.appendChild(E),a.appendChild(p),r&&Object.keys(r).length>0){let F=document.createElement("div");F.classList.add("voxels-stats-xp","voxels-stats-earnings"),F.innerHTML=`Skills <span>(${P})</span>`;let q=document.createElement("div");for(let[Y,A]of(q.classList.add("voxels-stats-xp-details"),Object.entries(r))){let W=document.createElement("div");W.classList.add("voxels-skill-xp-field");let j=document.createElement("img");j.src=`https://d31ss916pli4td.cloudfront.net/game/ui/skills/skills_icon_${Y}.png?v2`,W.appendChild(j);let z=document.createElement("div");z.classList.add("voxels-tasks-done"),z.innerHTML=`${A.tasks_done}<span class="voxels-superscript">${1===A.tasks_done?"Task":"Tasks"}</span>, `,W.appendChild(z);let G=document.createElement("div");G.classList.add("voxels-skill-xp"),G.innerHTML=`${A.xp}<span class="voxels-superscript">XP</span>`,W.appendChild(G),q.appendChild(W)}F.appendChild(q),a.appendChild(F)}a.appendChild(createIndividualTasks(o,c));let N=document.createElement("div");function X(e,t,s){var l,i,n,d=document.createElement("div");d.classList.add("voxels-main-info"),a.appendChild(d);var r=(l=e,i=d,(n=document.createElement("canvas")).id=l,n.style.width="100%",n.style.maxWidth="600px",i.appendChild(n),n.getContext("2d"));new Chart(r,{type:"line",data:t,options:s})}N.classList.add("voxels-stats-earnings","voxels-stats-earnings-graph"),N.innerHTML="Graphs",a.appendChild(N);var Z={responsive:!0,interaction:{mode:"index",intersect:!1},stacked:!1,plugins:{title:{display:!1,text:"Earnings Chart",color:"white"},legend:{labels:{color:"white"}},tooltip:{titleColor:"white",bodyColor:"white",backgroundColor:"black"}},scales:{x:{grid:{color:e=>0===e.tick.value?"white":"transparent"},ticks:{color:"white"}},y:{beginAtZero:!0,grid:{color:e=>0===e.tick.value?"white":"rgba(255, 255, 255, 0.2)"},border:{dash:e=>0===e.tick.value?[]:[2,4]},ticks:{color:"white"}}}};function J(e,t){var a=[],s=t.map(t=>(function e(t,a,s,l,i,n){for(var d={data:[],label:l,borderColor:i,backgroundColor:i,fill:!1,tension:.4},r=s;r>=0;r--){var o=new Date;o.setUTCDate(o.getUTCDate()-r);var c,p=o.toISOString().split("T")[0],v=o.getUTCDate()+"/"+(o.getUTCMonth()+1);n.includes(v)||n.push(v);for(var m=!1,x=0;x<t.length;x++)if(t[x].date===p){m=!0,d.data.push(t[x][a]);break}m||d.data.push(0)}return d})(e,t.key,t.maxItems,t.label,t.color,a));return{labels:a,datasets:s}}X("chartCanvas1",J(data,[{key:"pixels_made",maxItems:6,label:"Pixels made",color:"#5ff600"}]),Z),X("chartCanvas2",J(data,[{key:"coins_made",maxItems:6,label:"Coins made",color:"#e3ff36"},{key:"coins_spent",maxItems:6,label:"Coins spent",color:"#f75543"},{key:"coins_total",maxItems:6,label:"Coins total",color:"#f7af43"},{key:"c_p_ratio",maxItems:6,label:"Coins spent/Pixel",color:"#c2fa0a"}]),Z),X("chartCanvas3",J(data,[{key:"tasks_done",maxItems:6,label:"Tasks",color:"#0a0efa"},{key:"pixel_tasks",maxItems:6,label:"Pixel tasks",color:"#0afada"},{key:"t_p_ratio",maxItems:6,label:"Tasks/Pixel",color:"#0afa7a"},{key:"pixel_percentage",maxItems:6,label:"% Pixel tasks",color:"#7e0afa"},{key:"pixel_per_pixel_task",maxItems:6,label:"Pixel per Pixel task",color:"#198a2f"}]),Z)}else if("leaderboard"===e){let K=t.stats.leaderboard,Q=t.stats.minimumLevel,ee=t.stats.stats.extra.levels,et=K.season_active;if(et){let ea=K.season,es=K.season_info,el=K.season_prize;var ei=document.createElement("div");ei.classList.add("voxels-season");var en=document.createElement("div");en.classList.add("voxels-season-title");let ed=new Date(es.season_start),er=new Date(es.season_end),eo=ed.getDate()+"/"+(ed.getMonth()+1)+"/"+ed.getFullYear(),ec=er.getDate()+"/"+(er.getMonth()+1)+"/"+ed.getFullYear();en.innerHTML="<p class='voxels-text-color-main'>Voxels Season "+es.season_number+"</p> ("+eo+" - "+ec+")",ei.appendChild(en);var ep=document.createElement("div");ep.classList.add("voxels-season-table"),ei.appendChild(ep);for(var ev=0;ev<ea.length;ev++){var em=document.createElement("div");em.classList.add("voxels-leaderboard-row");var ex=document.createElement("div");ex.classList.add("voxels-leaderboard-column","voxels-text-color-main"),10==ev?ex.textContent="You":ex.innerHTML=ev+1+" <span>"+el[ev]+"<br><img class='voxels-leaderboard-pixels-icon' src='"+chrome.runtime.getURL("images/Other/Pixel.png")+"'></span>",em.appendChild(ex);var eg=document.createElement("div");eg.classList.add("voxels-leaderboard-column"),eg.textContent=ea[ev].username,ea[ev].username===s&&eg.classList.add("voxels-text-color-main"),em.appendChild(eg);var eh=document.createElement("div");eh.classList.add("voxels-leaderboard-column","voxels-text-color-main"),eh.textContent=ea[ev].pixels_made,em.appendChild(eh),ep.appendChild(em)}a.appendChild(ei)}let eu=K.day;var eL=document.createElement("div");eL.classList.add("voxels-leaderboard");var en=document.createElement("div");en.classList.add("voxels-leaderboard-title"),en.innerHTML="<span class='voxels-text-color-main'>Leaderboard</span> ("+i+") <img class='voxels-leaderboard-pixels-icon' src='"+chrome.runtime.getURL("images/Other/Pixel.png")+"'>",eL.appendChild(en);var e8=document.createElement("div");e8.classList.add("voxels-leaderboard-table"),eL.appendChild(e8);for(var ev=0;ev<eu.length;ev++)!function(e){var t=document.createElement("div");t.classList.add("voxels-leaderboard-row","clickable");var a=document.createElement("div");a.classList.add("voxels-leaderboard-column","voxels-text-color-main"),a.textContent=e+1,t.appendChild(a);var l=document.createElement("div");l.classList.add("voxels-leaderboard-column","clickable"),l.textContent=eu[e].username,eu[e].username===s&&l.classList.add("voxels-text-color-main"),t.appendChild(l);var i=document.createElement("div");i.classList.add("voxels-leaderboard-column","voxels-text-color-main"),i.textContent=eu[e].pixels_made,t.appendChild(i);var n=document.createElement("div");n.classList.add("voxels-details-container"),n.style.display="none";var d=document.createElement("div");d.classList.add("voxels-details-row");var r=document.createElement("div");r.classList.add("voxels-details-level");var o=document.createElement("div");o.classList.add("voxels-playerpage-skill-level"),o.innerHTML="<span class='voxels-playerpage-levelicon-prefix'>Lvl</span>"+eu[e].level,r.appendChild(o),d.appendChild(r);var c=document.createElement("div");c.classList.add("voxels-details-lands"),c.innerHTML=" "+eu[e].lands;var p=document.createElement("img");p.src=chrome.runtime.getURL("images/pixels_icon.png"),c.prepend(p),d.appendChild(c);var v=document.createElement("div");v.classList.add("voxels-details-vip"),v.classList.add("voxels-details-vip"),eu[e].vip&&v.classList.add("js-completed"),v.innerHTML="VIP&nbsp;";var m=document.createElement("img");m.src=eu[e].vip?chrome.runtime.getURL("images/icons/icon__task.svg"):chrome.runtime.getURL("images/icons/icon__xmark.svg"),v.appendChild(m),d.appendChild(v),n.appendChild(d);var x=document.createElement("div");x.classList.add("voxels-details-row","voxels-details-calc");var g=document.createElement("div");g.classList.add("voxels-details-column"),g.innerHTML=' Coins Spent: <span class="voxels-details-calc-number">'+nFormatter(eu[e].coins_spent,3)+"</span>",x.appendChild(g),n.appendChild(x);var h=document.createElement("div");h.classList.add("voxels-details-row","voxels-details-calc");var u=document.createElement("div");u.classList.add("voxels-details-column"),u.innerHTML=' Coins per Pixel: <span class="voxels-details-calc-number">'+nFormatter(eu[e].c_p_ratio,3)+"</span>",h.appendChild(u),n.appendChild(h);var L=document.createElement("div");L.classList.add("voxels-details-row","voxels-details-calc");var C=document.createElement("div");C.classList.add("voxels-details-column"),C.innerHTML=' Tasks done: <span class="voxels-details-calc-number">'+eu[e].tasks_done+"</span>",L.appendChild(C),n.appendChild(L);var k=document.createElement("div");k.classList.add("voxels-details-row");var f=document.createElement("div");f.classList.add("voxels-details-button");var E=document.createElement("button");E.textContent="Profile page";let b=eu[e].pid;E.addEventListener("click",function(){loadPlayerPageTop(),loadPlayerPage(b)}),f.appendChild(E),k.appendChild(f),n.appendChild(k),t.addEventListener("click",function(){n.style.display="none"===n.style.display?"block":"none"}),e8.appendChild(t),e8.appendChild(n)}(ev);if(a.appendChild(eL),Q){let eC=document.createElement("div");eC.classList.add("voxels-stats-min-section-title"),eC.innerText="Minimum Levels Required for Tasks",a.appendChild(eC),appendMinimumLevelsToPage(a,Q,ee)}var ek=document.createElement("div");if(ek.classList.add("voxels-stats-info"),ek.textContent="Stats get updated every 15 min.",a.appendChild(ek),!t.stats.stats.extra.optout){var ef=document.createElement("div");ef.classList.add("voxels-stats-info"),ef.innerHTML='To opt out of the leaderboard and Voxels Seasons you can click <a href="#" id="optOutLink">here</a>.',a.appendChild(ef),document.getElementById("optOutLink").addEventListener("click",function(e){e.preventDefault(),userOptout(t.stats.stats.extra.PID)})}}})}function appendMinimumLevelsToPage(e,t,a){for(let[s,l]of Object.entries(t)){let i=Object.entries(l).map(([e,t])=>Object.entries(t).map(([t,a])=>({item:e,reward:parseFloat(t),types:{Basic:a[0]?a[0].level:null,VIP:a[1]?a[1].level:null,Landowner:a[2]?a[2].level:null}}))).flat().sort((e,t)=>t.reward===e.reward?t.types.Basic-e.types.Basic:t.reward-e.reward),n=document.createElement("div");n.classList.add("voxels-stats-tasks-section","voxels-stats-skill-section");let d=e=>{let t=displayNamesJSONArray.find(t=>t.display_name===e);return t?t.image:""},r=void 0!==a[s]?a[s]:"N/A",o=document.createElement("div");o.classList.add("voxels-stats-tasks-section-title"),o.innerHTML=`<img src="https://d31ss916pli4td.cloudfront.net/game/ui/skills/skills_icon_${s}.png?v2">&nbsp;${s.charAt(0).toUpperCase()+s.slice(1)} (Level ${r})`,n.appendChild(o);let c=document.createElement("table");c.classList.add("voxels-stats-skill-table");let p=document.createElement("tr");p.innerHTML=`
            <th>Item</th>
            <th>Pixels</th>
            <th>Basic</th>
            <th><img src="${chrome.runtime.getURL("/images/Other/vip_coupon.png")}" class="header-image"></th>
            <th><img src="${chrome.runtime.getURL("/images/pixels_icon.png")}" class="header-image header-pixels"></th>
        `,c.appendChild(p),i.forEach(e=>{let t=d(e.item),a=null!==e.types.Basic&&r>=e.types.Basic?"voxels-stats-level-reached":"",s=null!==e.types.VIP&&r>=e.types.VIP?"voxels-stats-level-reached":"",l=null!==e.types.Landowner&&r>=e.types.Landowner?"voxels-stats-level-reached":"",i=document.createElement("tr");i.innerHTML=`
                <td><img src="${t}" class="task-item-image"> <span>${e.item}</span></td>
                <td><img src="${chrome.runtime.getURL("/images/Other/Pixel.png")}" class="pixel-image">${e.reward}</td>
                <td class="${a}">${null!==e.types.Basic?e.types.Basic:"-"}</td>
                <td class="${s}">${null!==e.types.VIP?e.types.VIP:"-"}</td>
                <td class="${l}">${null!==e.types.Landowner?e.types.Landowner:"-"}</td>
            `,c.appendChild(i)}),n.appendChild(c),e.appendChild(n)}}function createIndividualTasks(e,t){let a=document.createElement("div");a.classList.add("voxels-stats-basics");let s=document.createElement("div");if(s.classList.add("voxels-stats-earnings"),s.innerHTML="Tasks (last 24h)",null!==t){let l=document.createElement("div");l.classList.add("voxels-stats-last-task");let i=new Date(1e3*t).toLocaleString();l.innerHTML=`Last task delivered: <span>${i}</span>`,s.appendChild(l)}let n={0:"Basic",1:"VIP",2:"Landowner"},d={};e.sort((e,t)=>e.reward_type!==t.reward_type?e.reward_type.localeCompare(t.reward_type):parseFloat(e.reward_amount)!==parseFloat(t.reward_amount)?parseFloat(t.reward_amount)-parseFloat(e.reward_amount):e.task_item!==t.task_item?e.task_item.localeCompare(t.task_item):e.type-t.type),e.forEach(e=>{if("pixels"===e.reward_type){let t=`${e.task_item}_${e.reward_amount}`;d[t]||(d[t]={task_item:e.task_item,reward_amount:e.reward_amount,types:{}});let a=n[e.type];d[t].types[a]||(d[t].types[a]=0),d[t].types[a]++}});let r=e=>{let t=displayNamesJSONArray.find(t=>t.display_name===e);return t?t.image:""},o=document.createElement("div");o.classList.add("voxels-stats-tasks-section");let c={Basic:0,VIP:0,Landowner:0};Object.values(d).forEach(e=>{c.Basic+=(e.types.Basic||0)*parseFloat(e.reward_amount),c.VIP+=(e.types.VIP||0)*parseFloat(e.reward_amount),c.Landowner+=(e.types.Landowner||0)*parseFloat(e.reward_amount)}),c.Basic=c.Basic.toFixed(1),c.VIP=c.VIP.toFixed(1),c.Landowner=c.Landowner.toFixed(1),o.innerHTML=`
    <div class="voxels-stats-tasks-section-title">
        <img src="${chrome.runtime.getURL("/images/Other/Pixel.png")}" class="pixel-image">&nbsp;Pixel tasks
    </div>
    <div class="voxels-stats-tasks-section-totals">
        <div>Pixels Basic:&nbsp;<img src="${chrome.runtime.getURL("/images/Other/Pixel.png")}" class="pixel-image">${c.Basic}</div>
        <div>Pixels&nbsp;<img src="${chrome.runtime.getURL("/images/Other/vip_coupon.png")}" class="header-image">:&nbsp;<img src="${chrome.runtime.getURL("/images/Other/Pixel.png")}" class="pixel-image">${c.VIP}</div>
        <div>Pixels&nbsp;<img src="${chrome.runtime.getURL("/images/pixels_icon.png")}" class="header-image header-pixels">:&nbsp;<img src="${chrome.runtime.getURL("/images/Other/Pixel.png")}" class="pixel-image">${c.Landowner}</div>
    </div>
`;let p=document.createElement("table");p.classList.add("voxels-stats-tasks-table");let v=document.createElement("tr");v.innerHTML=`
    <th>Item</th>
    <th>Pixels</th>
    <th>Basic</th>
    <th><img src="${chrome.runtime.getURL("/images/Other/vip_coupon.png")}" class="header-image"></th>
    <th><img src="${chrome.runtime.getURL("/images/pixels_icon.png")}" class="header-image header-pixels"></th>
`,p.appendChild(v),Object.values(d).forEach(e=>{let t=e.task_item,a=r(t),s=parseFloat(e.reward_amount).toString(),l=e.types.Basic||0,i=e.types.VIP||0,n=e.types.Landowner||0,d=document.createElement("tr");d.innerHTML=`
        <td><img src="${a}" class="task-item-image"> <span>${t}</span></td>
        <td><img src="${chrome.runtime.getURL("/images/Other/Pixel.png")}" class="pixel-image">${s}</td>
        <td>${l}</td>
        <td>${i}</td>
        <td>${n}</td>
    `,p.appendChild(d)}),o.appendChild(p),s.appendChild(o);let m={};e.forEach(e=>{let t=e.task_item;m[t]||(m[t]={task_item:e.task_item,total_delivered:0}),m[t].total_delivered+=e.quantity});let x=Object.values(m).sort((e,t)=>e.task_item.localeCompare(t.task_item)),g=document.createElement("div");g.classList.add("voxels-stats-tasks-section"),g.innerHTML='<div class="voxels-stats-tasks-section-title">Delivered Items</div>';let h=document.createElement("table");h.classList.add("voxels-stats-tasks-table","voxels-stats-tasks-delivered");let u=document.createElement("tr");return u.innerHTML=`
    <th>Item</th>
    <th>Total Delivered</th>
`,h.appendChild(u),x.forEach(e=>{let t=e.task_item,a=r(t),s=nFormatter(parseFloat(e.total_delivered).toString(),2),l=document.createElement("tr");l.innerHTML=`
        <td><img src="${a}" class="task-item-image"> <span>${t}</span></td>
        <td>${s}</td>
    `,h.appendChild(l)}),g.appendChild(h),s.appendChild(g),a.appendChild(s),a}function userOptout(e){voxelsConfirm("If you continue you won't be able to participate in this Voxels Season or the Leaderboard. Opt out?",function(t){t&&chrome.storage.local.get("user_info",async function(t){let a=t.user_info;loadingScreen(1);try{let s=await makeFetchRequest(apiURL,{name:a,operation:"leaderboardOptout",extra:e});handleErrors(s)||("logout"==s?initiate():(loadingScreen(0),refreshStats(),quickMessage("You have opted out of Voxels Seasons & the leaderboard.","news")))}catch(l){console.error(l)}})})}function statsCalculations(e){let t=new Date().toISOString().slice(0,10),a=e.some(e=>e.date===t);return a||e.push({date:t,pixels_made:0,coins_made:0,coins_spent:0,tasks_done:0,pixel_tasks:0,coins_total:0,c_p_ratio:0,t_p_ratio:0,pixel_percentage:0,normal_tasks:0}),e.forEach(e=>{let t=e.pixels_made,a=e.coins_made,s=e.coins_spent,l=e.tasks_done,i=e.pixel_tasks,n=s-a;e.coins_spent*=-1,e.coins_total=-1*n,e.c_p_ratio=t>0?n/t:0,e.t_p_ratio=t>0?l/t:0,e.pixel_percentage=l>0?i/l*100:0,e.pixel_per_pixel_task=t>0?t/i:0,e.normal_tasks=l-i}),e}function clearStatsPage(){document.querySelector(".voxels-stats-page").innerHTML=""}