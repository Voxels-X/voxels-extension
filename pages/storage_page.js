function loadStorages(e){e?chrome.storage.local.get("user_info",(async function(e){const t={name:e.user_info,operation:"getStorage"};try{const e=await makeFetchRequest(apiURL,t);handleErrors(e)||("logout"==e?initiate():loadStoragePage(e.data))}catch(e){}})):chrome.storage.local.get("storage_data",(function(e){e.storage_data?loadStoragePage(e.storage_data):loadStoragePage([])}))}function loadStoragePage(e){const t=document.querySelector(".voxels-main");var o=document.createElement("div");o.classList.add("voxels-main-page"),o.classList.add("active"),loadFilterStorages(o),t.appendChild(o),setStorages(e),reloadFooter()}function loadFilterStorages(e){var t=document.createElement("div");t.classList.add("voxels-filter-container");var o=document.createElement("input");function a(){const t=o.value.toLowerCase();e.querySelectorAll(".voxels-main-storage").forEach((e=>{const o=e.querySelector(".voxels-main-storage-text").textContent.toLowerCase().includes(t),a=Array.from(e.querySelectorAll(".voxels-storage-item-name")).some((e=>e.textContent.toLowerCase().includes(t)));e.style.display=o||a?"":"none"}))}o.setAttribute("type","text"),o.setAttribute("placeholder","Filter storages..."),o.classList.add("voxels-farm-filter-input"),t.appendChild(o),e.appendChild(t),o.addEventListener("keydown",(function(e){setTimeout(a,10),e.stopPropagation()}))}function setStorages(e){for(let t in e){createStorage(e[t],t)}}function createStorage(e,t){var o,a=document.querySelector(".voxels-storage-"+t);if(a)(d=(o=a).querySelector(".voxels-storages-container")).innerHTML="";else{(o=document.createElement("div")).classList.add("voxels-main-storage"),o.classList.add("voxels-storage-"+t);var r=document.createElement("div");r.classList.add("voxels-main-storage-header"),o.appendChild(r);var n=document.createElement("div");n.classList.add("voxels-main-storage-text"),n.textContent=t,r.appendChild(n);var s=document.createElement("div");s.classList.add("voxels-main-storage-buttons"),r.appendChild(s);var i=document.createElement("img");i.classList.add("voxels-storage-update"),i.src=chrome.runtime.getURL("/images/icons/icon__refresh.svg"),i.addEventListener("click",(function(){isAddingStorage||intervalActive?showAlert("Cannot add storage while processing.","error"):(isAddingStorage=!0,updateStorage(0,t))})),s.appendChild(i);var l=document.createElement("div");l.classList.add("voxels-main-remove");var d,c=document.createElement("div");c.classList.add("voxels-remove-icon"),c.textContent="X",l.addEventListener("click",(function(){removeStorage(t)})),l.appendChild(c),s.appendChild(l),(d=document.createElement("div")).classList.add("voxels-storages-container")}if(e.forEach((e=>{if("0"===e){(t=document.createElement("div")).classList.add("voxels-storageItem"),d.appendChild(t)}else{var t,o=e.display_name,a=e.image,r=e.quantity;(t=document.createElement("div")).classList.add("voxels-storageItem");var n=document.createElement("img");n.src=a,t.appendChild(n);var s=document.createElement("div");s.classList.add("voxels-storage-quantity"),s.textContent=r,t.appendChild(s);var i=document.createElement("div");i.classList.add("voxels-storage-item-name"),i.textContent=o,i.style.display="none",t.appendChild(i),t.addEventListener("mouseenter",(function(){var e=document.createElement("div");e.classList.add("voxels-hover-box"),e.textContent=o,document.body.appendChild(e);var a=t.getBoundingClientRect();e.style.position="absolute",e.style.top=a.top-e.offsetHeight+"px",e.style.left=a.left-50+"px"})),t.addEventListener("mouseleave",(function(){document.querySelectorAll(".voxels-hover-box").forEach((function(e){e.parentNode&&e.parentNode.removeChild(e)}))})),d.appendChild(t)}})),o.appendChild(d),!a){var m=document.querySelector(".voxels-main-page");m&&m.appendChild(o)}reloadFooter()}function updateStorage(e,t){0===e&&(e=getCurrentStorage()),!1!==e?chrome.storage.local.get("user_info",(async function(o){const a={name:o.user_info,operation:"updateStorage",extra:{storageName:t,items:e.items}};try{let o=await makeFetchRequest(apiURL,a);o=o.data,"correct"===o.status?correctStorage(e,o,t,updateStorage):"success"===o.status?(createStorage(o.display_names_images,t),chrome.storage.local.get("storage_data",(function(e){let a=e.storage_data||{};a[t]=o.display_names_images,chrome.storage.local.set({storage_data:a})}))):handleStorageError(o),isAddingStorage=!1}catch(e){}})):(isAddingStorage=!1,showAlert("Please open a valid storage.","error"))}function removeStorage(e){confirmRemoval(e,(function(t){t&&chrome.storage.local.get("user_info",(async function(t){const o={name:t.user_info,operation:"removeStorage",extra:e};try{if("success"===(await makeFetchRequest(apiURL,o)).data){const t=`.voxels-storage-${e}`;document.querySelector(t).remove(),chrome.storage.local.get("storage_data",(function(t){let o=t.storage_data||{};delete o[e],chrome.storage.local.set({storage_data:o})})),reloadFooter()}}catch(e){}}))}))}function confirmRemoval(e,t){var o=document.createElement("div");o.classList.add("voxels-popup-storage","voxels-popup-info"),o.innerHTML='<h3>Are you sure you want to remove storage:"'+e+'"?</h3><button id="confirmButton">Yes</button>';var a=document.createElement("div");function r(){o.remove()}a.className="voxels-popup-close",a.innerHTML="X",o.appendChild(a),document.body.appendChild(o),a.addEventListener("click",r),document.getElementById("confirmButton").addEventListener("click",(function(){t(!0),r()}))}function reloadFooter(){const e=document.querySelector(".voxels-main-page");document.querySelectorAll(".voxels-main-new").forEach((e=>{e.remove()}));document.querySelectorAll(".voxels-main-premium").forEach((e=>{e.remove()}));const t=e.querySelectorAll(".voxels-main-storage").length;t<40&&(t>0?premium&&addStorageButton():addStorageButton()),premium||displayPremium()}let isAddingStorage=!1,intervalActive=!1;function addStorageButton(){const e=document.querySelector(".voxels-main");var t=document.createElement("div");t.classList.add("voxels-main-new","voxels-border"),e.appendChild(t),t.innerHTML="Add current storage",t.addEventListener("click",(function(){isAddingStorage||intervalActive?showAlert("Cannot add storage while processing.","error"):(isAddingStorage=!0,addStorage(0,""))}))}function getStorageName(e){var t=document.createElement("div");t.className="voxels-popup-storage",t.innerHTML='<h3>Enter Storage Name:</h3><input type="text" id="storageNameInput" placeholder="Enter storage name..."><button id="submitButton">OK</button>',t.classList.add("voxels-popup-info");var o=t.querySelector("#storageNameInput");o.addEventListener("keydown",(function(e){document.activeElement===o&&e.stopPropagation()}));var a=document.createElement("div");a.className="voxels-popup-close",a.innerHTML="X",t.appendChild(a),document.body.appendChild(t),a.addEventListener("click",(function(){t.remove(),isAddingStorage=!1})),document.getElementById("storageNameInput").focus(),document.getElementById("submitButton").addEventListener("click",(function(){var o=document.getElementById("storageNameInput").value.trim();/^[a-zA-Z0-9]+$/.test(o)?o.length<=10?(e(o),t.remove()):(isAddingStorage=!1,showAlert("Please enter a storage name with a maximum of 10 characters.","error")):(isAddingStorage=!1,showAlert("Please enter a storage name containing only letters or numbers.","error"))}))}function addStorage(e,t){if(0===e&&(e=getCurrentStorage()),!1!==e){if(""===t)return void getStorageName((function(t){addStorage(e,t)}));sendStorageRequest(e.items,t).then((o=>{"correct"===o.status?correctStorage(e,o,t,addStorage):"success"===o.status?(createStorage(o.display_names_images,t),chrome.storage.local.get("storage_data",(function(e){let a=e.storage_data||{};Array.isArray(a)&&(a=convertArrayToObject(a)),a[t]=o.display_names_images,chrome.storage.local.set({storage_data:a})}))):handleStorageError(o),isAddingStorage=!1})).catch((e=>{isAddingStorage=!1}))}else isAddingStorage=!1,showAlert("Please open a valid storage.","error")}function correctStorage(e,t,o,a){intervalActive=!0;let r=0,n=t.item_names,s=[];for(let t=0;t<n.length;t++){if("multiple"===n[t]){const t=e.elements[r];if(t.classList.add("voxels-multiple"),t){const e=t.querySelector(nodeNames.storageItemBackground);e&&(e.style.filter="brightness(110%) hue-rotate(130deg)",s.push({imgElement:e,index:r}))}}r++}if(0===s.length)return void(intervalActive=!1);showAlert("Couldn't identify all items. Hover over the red items.","info");let i=setInterval((function(){if(!document.querySelector(nodeNames.storageBox))return clearInterval(i),intervalActive=!1,void showAlert("Stopped adding storage.","info");for(let t=0;t<s.length;t++){const{imgElement:o,index:a}=s[t],r=checkForToolTip(o),n=o.closest(nodeNames.storageItem).querySelector(nodeNames.storageQuantity),i=n?n.textContent.trim():"0";!1!==r&&(e.items[a]={type:"name",data:r,position:a,quantity:i},s.splice(t,1),t--)}0===s.length&&(clearInterval(i),intervalActive=!1,a(e,o))}),100)}function checkForToolTip(e){const t=e.closest(nodeNames.storageItem);if(t){const o=t.getAttribute("aria-labelledby");if(o){const t=document.getElementById(o);if(t){const o=t.querySelector(".ItemStyles_tooltipTitle____kIs").innerHTML.split("<br>")[0];return e.style.filter="",o}}}return!1}function sendStorageRequest(e,t){return new Promise((async(o,a)=>{chrome.storage.local.get("user_info",(async function(r){const n={name:r.user_info,operation:"addStorage",extra:{storageName:t,items:e}};try{const e=await makeFetchRequest(apiURL,n);o(e.data)}catch(e){a(e)}}))}))}function getCurrentStorage(){const e=document.querySelectorAll(nodeNames.storageBox);let t=[];return e.length>0&&(t.elements=e,storageItems=[],e.forEach(((e,t)=>{const o=e.querySelector(nodeNames.storageImage),a=e.querySelector(nodeNames.storageQuantity);if(o&&a){if(o.complete){const e=calculateAverageColor(o);storageItems.push({type:"hash",data:e,position:t,quantity:a.textContent})}}else storageItems.push({position:t})})),t.items=storageItems,t)}function handleStorageError(e){if(e&&e.status&&e.status.error)switch(e.status.error){case"4002":showAlert("A storage with this name already exists.","error");break;default:showAlert("An error occurred. Please try again.","error")}}