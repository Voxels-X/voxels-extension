var currentTasksElements,currentTasksData=[],currentTasks=[],setInitialData=!1;function loadTasks(e){premium?chrome.storage.local.get("task_data",function(e){e.task_data?loadTaskPage(e.task_data):loadTaskPage(!1)}):displayPremium()}function loadTaskPage(e){reloadOverlay();let t=document.querySelector(".voxels-main");if(!1===e){let a=document.createElement("div");a.classList.add("voxels-main-tasks"),t.appendChild(a);let s=document.createElement("div");s.textContent="Open the tasks to start.",a.appendChild(s)}else displayTaskStats(t),t.appendChild(createTaskContainer(e)),setTasksCost(),addTaskQuantities(),setInitialData||(setInitialData=!0,currentTasksData=e)}function displayTaskStats(e){chrome.storage.local.get("deliveredTasks",function(t){let a=t.deliveredTasks||[],s=Date.now(),i=a.filter(e=>s-e.timestamp<=3e5).length,l=a.filter(e=>s-e.timestamp<=36e5).length,n=document.querySelector(".task-stats");n||((n=document.createElement("div")).classList.add("voxels-task-pace"),e.insertBefore(n,e.firstChild));let r=`${(i/5).toFixed(2)}`,o=`${(l/60).toFixed(2)}`;n.innerHTML=`   
        <div class="voxels-task-pace-cell">
            <div class="voxels-task-pace-cell-data">${r}</div><div class="voxels-task-pace-cell-info">tasks/min</div>
        </div>
        <div class="voxels-task-pace-cell">
            <div class="voxels-task-pace-cell-data">${o}</div><div class="voxels-task-pace-cell-info">tasks/hour</div>
        </div>`})}function createTaskContainer(e){var t=document.createElement("div");return!0===taskboardTiles?t.classList.add("voxels-task-items-container","js-minimal-styling"):t.classList.add("voxels-task-items-container"),e.forEach(e=>{var a=document.createElement("div");a.classList.add("voxels-task-item");var s=document.createElement("div");s.classList.add("voxels-task-item-primary"),a.appendChild(s);var i=document.createElement("div");i.classList.add("voxels-task-item-visual"),s.appendChild(i);var l=document.createElement("img");l.src=e.image,i.appendChild(l);var n=document.createElement("div");if(n.classList.add("voxels-task-item-visual-tier"),n.textContent=e.tier,i.appendChild(n),"VIP"==e.name){a.classList.add("voxels-task-ready");var r=document.createElement("div");r.classList.add("voxels-task-name","js-voxels-task-name-reload-state"),r.innerHTML=e.name,a.appendChild(r)}else if("Loading..."!==e.name){a.classList.add("voxels-task-ready");var o=document.createElement("div");o.classList.add("voxels-task-quantity","voxels-task-main-quantity"),o.textContent=e.quantity,s.appendChild(o);var r=document.createElement("div");if(r.classList.add("voxels-task-name"),r.innerHTML='<div class="voxels-task-name-text">'+e.name+"</div>",a.appendChild(r),e.skillType&&e.skillXp){var d=document.createElement("div");d.classList.add("voxels-task-skill");var c="https://d31ss916pli4td.cloudfront.net/game/ui/skills/skills_icon_"+e.skillType.toLowerCase()+".png?v2",k=document.createElement("img");k.src=c,k.alt=e.skillType+" icon",k.classList.add("voxels-task-skill-image"),d.appendChild(k);var v=document.createElement("span");v.classList.add("voxels-task-skill-xp"),v.textContent=e.skillXp,d.appendChild(v),a.appendChild(d)}var p=document.createElement("div");p.classList.add("voxels-task-cost-container");var u=document.createElement("div");u.classList.add("voxels-task-reward");var m=document.createElement("img");m.classList.add("voxels-task-cost-icon"),e.rewardCurrency.includes("coins")?m.src=chrome.runtime.getURL("/images/Prices/coin.png"):e.rewardCurrency.includes("cur_pixel")?m.src=chrome.runtime.getURL("/images/Other/Pixel.png"):m.src=e.rewardCurrency,u.appendChild(m);var y=document.createElement("div");y.classList.add("voxels-task-reward"),y.textContent=e.rewardAmount,u.appendChild(y),p.appendChild(u),a.appendChild(p),("VIP"===e.type||"Landowner"===e.type)&&("VIP"===e.type?a.classList.add("vip"):"Landowner"===e.type&&a.classList.add("landowner"))}else{var r=document.createElement("div");r.classList.add("voxels-task-name","js-voxels-task-name-reload-state");var x=e.finished,f=Date.now(),T=Math.floor((f-x)/1e3);if(void 0===e.finished||T>300)r.innerHTML='<div class="voxels-task-name-text">Visit task board to reload..</div>',a.appendChild(r);else{var r=document.createElement("div");r.classList.add("voxels-task-name","js-voxels-task-name-reload-state");var x=e.finished,f=Date.now(),T=Math.floor((f-x)/1e3);if(T>taskTimerSec)r.innerHTML='<div class="voxels-task-name-text">Visit task board to reload..</div>',a.appendChild(r);else{var h=taskTimerSec-T,C=Math.floor(h/60),g=h%60;r.innerHTML='<div class="voxels-task-name-text">'+(C+":")+(g<10?"0":"")+g+"</div>",a.appendChild(r);var L=setInterval(function(){var e=Math.floor(--h/60),t=h%60;r.innerHTML='<div class="voxels-task-name-text">'+(e+":")+(t<10?"0":"")+t+"</div>",h<=0&&(clearInterval(L),r.innerHTML='<div class="voxels-task-name-text">Visit task board to reload..</div>')},1e3)}}}t.appendChild(a)}),currentTasksElements=t,t}function checkTasks(){compareTasks().then(e=>{e&&chrome.storage.local.get("task_data",function(e){currentTasks=getCurrentTasks(e),chrome.storage.local.set({task_data:currentTasks}),"tasks"===currentActiveTab&&premium&&loadTaskPage(currentTasks),setTaskData(currentTasks).then(e=>{if("success"===e)return})})}).catch(e=>{console.log("Error comparing tasks:",e)})}function compareTasks(){return new Promise((e,t)=>{chrome.storage.local.get("task_data",function(t){if(t.task_data){let a=getCurrentTasks(0),s=t.task_data;a.length!==s.length&&e(!0);for(let i=0;i<a.length;i++)compareTaskObjects(a[i],s[i])||e(!0);e(!1)}else e(!0)})})}function compareTaskObjects(e,t){return e.name===t.name&&e.quantity===t.quantity&&e.position===t.position&&e.rewardCurrency===t.rewardCurrency&&e.rewardAmount===t.rewardAmount&&e.type===t.type&&e.skillType===t.skillType}function setTaskData(e){return new Promise(async(t,a)=>{chrome.storage.local.get("pid",async function(s){let i=s.pid;try{let l=await makeFetchRequest(apiURL,{pid:i,operation:"saveTasks",extra:e});t(l.data)}catch(n){a(n)}})})}function getCurrentTasks(e){let t=document.querySelectorAll(nodeNames.tasksCard);if(t.length>0){let a=[];if(t.forEach((e,t)=>{if(!e.classList.contains(nodeNames.tasksTitle)){let s=e.querySelector(nodeNames.tasksTitle);if(s){let i=s.innerText,l,n,r,o,d="";"NEW TASK IN:"===i?i="Loading...":"vip"===i?i="VIP":(l=e.querySelectorAll(nodeNames.tasksCostDisplay)[1].querySelector(nodeNames.tasksCostImage).src,n=e.querySelectorAll(nodeNames.tasksCostDisplay)[1].querySelector(nodeNames.tasksCost).innerText);let c=e.querySelector(nodeNames.tasksImage).src,k=e.querySelector(nodeNames.tasksQuantity),v=k?parseInt(k.innerText,10):1,p="Basic",u=e.querySelector(nodeNames.tasksWrapper);u&&(u.classList.contains(nodeNames.tasksVIP)?p="VIP":u.classList.contains(nodeNames.tasksLandowner)&&(p="Landowner")),e.querySelector(nodeNames.taskTier)&&(r=e.querySelector(nodeNames.taskTier).textContent);let m=currentTasksData.find(e=>e.position===t&&e.name===i&&e.quantity===v&&e.type===p);m&&(l=m.rewardCurrency,o=m.skillType,d=m.skillXp);let y={name:i,quantity:v,image:c,rewardCurrency:l,rewardAmount:n,position:t,type:p,tier:r,skillType:o,skillXp:d};if("Loading..."===i){let x=currentTasks.find(e=>e.position===t);x&&"Loading..."===x.name?y.finished=x.finished:y.finished=Date.now()}let f=e.querySelector("button");!f||f.disabled||f.hasAttribute("data-listener-attached")||(f.addEventListener("click",function(){deliverTask(y)}),f.setAttribute("data-listener-attached","true")),a.push(y)}}}),a.length>0)return a}}function deliverTask(e){let t=currentTasksData.find(t=>t.position===e.position&&t.name===e.name&&t.quantity===e.quantity&&t.type===e.type);t&&(e.rewardCurrency=t.rewardCurrency,e.rewardAmount=t.rewardAmount,e.skillType=t.skillType,e.skillXp=t.skillXp),chrome.storage.local.get("deliveredTasks",function(t){let a=t.deliveredTasks||[],s=Date.now();a=a.filter(e=>s-e.timestamp<=36e5);let i=a.some(t=>t.position===e.position&&t.name===e.name&&t.quantity===e.quantity&&t.type===e.type&&t.rewardAmount===e.rewardAmount&&s-t.timestamp<=12e5);i||(a.push({...e,timestamp:s}),chrome.storage.local.set({deliveredTasks:a}),chrome.storage.local.get("pid",async function(t){let a=t.pid;try{await makeFetchRequestByPID(apiURL,{pid:a,operation:"deliverTask",extra:e})}catch(s){console.error("Error delivering task:",s)}}))})}function setTasksCost(){"tasks"==currentActiveTab&&chrome.storage.local.get("task_data",async function(e){let t=e.task_data.map(e=>e.name);loadTasksCost(t).then(e=>{e.forEach((e,t)=>{let a=currentTasksElements.querySelector(`.voxels-task-item:nth-child(${t+1})`);if(a&&null!==e.price){let s=a.querySelector(".voxels-task-main-quantity"),i=s?parseInt(s.textContent,10):1;var l=parseInt(e.price,10)*i;let n=a.querySelector(".voxels-task-cost-container"),r=n.querySelector(".voxels-task-cost");r||((r=document.createElement("div")).classList.add("voxels-task-cost"),n.appendChild(r));let o=r.querySelector("img");o||((o=document.createElement("img")).classList.add("voxels-task-cost-icon"),r.appendChild(o)),o.src=chrome.runtime.getURL("/images/Prices/coin.png");let d=r.querySelector(".voxels-task-cost-amount");d||((d=document.createElement("div")).classList.add("voxels-task-cost-amount"),r.appendChild(d)),d.textContent=nFormatter(Math.abs(l),1);let c=currentTasksData.find(e=>e.position===t&&e.quantity===i);if(c){if(c.rewardCurrency.includes("coins")){let k=parseFormattedAmount(c.rewardAmount)-parseInt(e.price,10)*i,v=a.querySelector(".voxels-task-total");v||((v=document.createElement("div")).classList.add("voxels-task-total"),a.appendChild(v)),v.innerHTML="";let p=document.createElement("img");p.classList.add("voxels-task-cost-icon"),p.src=chrome.runtime.getURL("/images/Prices/coin.png"),v.appendChild(p);let u=document.createElement("span");u.classList.add("voxels-task-total-amount"),u.textContent=nFormatter(Math.abs(k),1),v.appendChild(u),k<0?u.classList.add("voxels-task-total-negative"):u.classList.add("voxels-task-total-positive")}else if(c.rewardCurrency.includes("cur_pixel")){let m=parseInt(e.price,10)*i/c.rewardAmount,y=a.querySelector(".voxels-task-total");y||((y=document.createElement("div")).classList.add("voxels-task-total"),a.appendChild(y)),y.innerHTML="";let x=document.createElement("span");x.textContent="C/P = ",y.appendChild(x);let f=document.createElement("span");f.classList.add("voxels-task-total-amount"),f.textContent=nFormatter(m,2),y.appendChild(f)}}}else if("Loading..."!==e.name){let T=a.querySelector(".voxels-task-total");T||((T=document.createElement("div")).classList.add("voxels-task-total"),a.appendChild(T)),T.innerHTML="",T.textContent="N/A"}})}).catch(e=>{console.error(e)})})}function loadTasksCost(e){return new Promise(async(t,a)=>{chrome.storage.local.get("user_info",async function(s){let i={name:s.user_info,operation:"fetchPricesByName",extra:e};try{let l=await makeFetchRequest(apiURL,i),n=l.data,r=e.map(e=>({name:e,price:n[e]}));t(r)}catch(o){a(o)}})})}function addTaskQuantities(){if(currentInventory&&currentInventory.items){let e=new Map;for(let t of currentInventory.items){let a=displayNamesJSONArray.find(e=>e.item===t.item),s=a?a.display_name:t.item;e.has(s)?e.get(s).quantity+=t.quantity:e.set(s,{display_name:s,quantity:t.quantity})}let i=Array.from(e.values()),l=document.querySelectorAll(".voxels-task-item");l.forEach(e=>{if(e.querySelector(".js-voxels-task-name-reload-state"))return;let t=e.querySelector(".voxels-task-name").textContent,a=i.find(e=>e.display_name===t),s=a?a.quantity:0,l=e.querySelector(".voxels-task-main-quantity").textContent,n=e.querySelector(".voxels-task-quantity-container");if(n){let r=n.querySelector(".voxels-task-quantity:first-child");r&&(r.textContent=s)}else(n=document.createElement("div")).className="voxels-task-quantity-container",n.innerHTML=`<div class="voxels-task-quantity">${s}</div>/<div class="voxels-task-quantity voxels-task-main-quantity">${l}</div>`,e.querySelector(".voxels-task-quantity").replaceWith(n);s>=l?e.classList.add("voxels-task-achievable"):e.classList.remove("voxels-task-achievable")})}}window.addEventListener("message",function(e){e.data&&"VOXELS_TASK_DATA"===e.data.type&&(currentTasksData=e.data.value)},!1);