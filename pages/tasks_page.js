var currentTasksElements,currentTasksData=[],currentTasks=[],setInitialData=!1;function loadTasks(e){premium?chrome.storage.local.get("task_data",function(e){e.task_data?loadTaskPage(e.task_data):loadTaskPage(!1)}):displayPremium()}function loadTaskPage(e){reloadOverlay();let t=document.querySelector(".voxels-main");if(!1===e){let a=document.createElement("div");a.classList.add("voxels-main-tasks"),t.appendChild(a);let s=document.createElement("div");s.textContent="Open the tasks to start.",a.appendChild(s)}else displayTaskStats(t),t.appendChild(createTaskContainer(e)),setTasksCost(),addTaskQuantities(),setInitialData||(setInitialData=!0,currentTasksData=e)}function displayTaskStats(e){chrome.storage.local.get("deliveredTasks",function(t){let a=t.deliveredTasks||[],s=Date.now();a.filter(e=>s-e.timestamp<=3e5).length;let i=a.filter(e=>s-e.timestamp<=36e5).length,n=document.querySelector(".task-stats");n||((n=document.createElement("div")).classList.add("voxels-task-pace"),e.insertBefore(n,e.firstChild));let l=`${(i/60).toFixed(2)}`,r=`${i.toFixed(2)}`;n.innerHTML=`   
        <div class="voxels-task-pace-cell">
            <div class="voxels-task-pace-cell-data">${l}</div><div class="voxels-task-pace-cell-info">tasks/min</div>
        </div>
        <div class="voxels-task-pace-cell">
            <div class="voxels-task-pace-cell-data">${r}</div><div class="voxels-task-pace-cell-info">tasks/hour</div>
        </div>`})}function createTaskContainer(e){var t=document.createElement("div");return!0===taskboardTiles?t.classList.add("voxels-task-items-container","js-minimal-styling"):t.classList.add("voxels-task-items-container"),e.forEach(e=>{var a=document.createElement("div");a.classList.add("voxels-task-item");var s=document.createElement("div");s.classList.add("voxels-task-item-primary"),a.appendChild(s);var i=document.createElement("div");i.classList.add("voxels-task-item-visual"),s.appendChild(i);var n=document.createElement("img");let l=displayNamesJSONArray.find(t=>t.display_name===e.name);n.src=l?l.image:e.image,i.appendChild(n);var r=document.createElement("div");if(r.classList.add("voxels-task-item-visual-tier"),r.textContent=e.tier,i.appendChild(r),"VIP"==e.name){a.classList.add("voxels-task-ready");var o=document.createElement("div");o.classList.add("voxels-task-name","js-voxels-task-name-reload-state"),o.innerHTML=e.name,a.appendChild(o)}else if("Loading..."!==e.name){a.classList.add("voxels-task-ready");var d=document.createElement("div");d.classList.add("voxels-task-quantity","voxels-task-main-quantity"),d.textContent=e.quantity,s.appendChild(d);var o=document.createElement("p");if(o.classList.add("voxels-task-name","clickable"),o.setAttribute("id","voxels-copy"),o.setAttribute("translate","no"),o.innerHTML='<div class="voxels-task-name-text">'+e.name+"</div><img src='"+chrome.runtime.getURL("images/icons/icon__copy.svg")+"' alt='Copy Icon'>",a.appendChild(o),o.addEventListener("click",function(){var t=document.createElement("textarea");t.value=e.name,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t);var a=document.querySelector(nodeNames.market_search);if(a){a.value=e.name;var s=new Event("input",{bubbles:!0});a.dispatchEvent(s)}else{var i=document.createElement("div");i.classList.add("voxels-hover-box"),i.textContent="Copied!",document.body.appendChild(i);var n=o.getBoundingClientRect();i.style.position="absolute",i.style.top=n.top-i.offsetHeight+"px",i.style.left=n.left+"px",setTimeout(function(){document.body.removeChild(i)},2e3)}}),e.skillType&&e.skillXp){var c=document.createElement("div");c.classList.add("voxels-task-skill");var v="https://d31ss916pli4td.cloudfront.net/game/ui/skills/skills_icon_"+e.skillType.toLowerCase()+".png?v2",p=document.createElement("img");p.src=v,p.alt=e.skillType+" icon",p.classList.add("voxels-task-skill-image"),c.appendChild(p);var u=document.createElement("span");u.classList.add("voxels-task-skill-xp"),u.textContent=e.skillXp,c.appendChild(u),a.appendChild(c)}var k=document.createElement("div");k.classList.add("voxels-task-cost-container");var m=document.createElement("div");m.classList.add("voxels-task-reward");var y=document.createElement("img");y.classList.add("voxels-task-cost-icon"),"string"==typeof e.rewardCurrency?e.rewardCurrency.includes("coins")?y.src=chrome.runtime.getURL("/images/Prices/coin.png"):e.rewardCurrency.includes("cur_pixel")?y.src=chrome.runtime.getURL("/images/Other/Pixel.png"):y.src=e.rewardCurrency:y.src=chrome.runtime.getURL("/images/Prices/coin.png"),m.appendChild(y);var x=document.createElement("div");x.classList.add("voxels-task-reward"),x.textContent=e.rewardAmount,m.appendChild(x),k.appendChild(m),a.appendChild(k),("VIP"===e.type||"Landowner"===e.type)&&("VIP"===e.type?a.classList.add("vip"):"Landowner"===e.type&&a.classList.add("landowner"));var f=getItmByName(e.name);a.addEventListener("mouseenter",function(){f&&(currentItemHovered=f,itemHoverLoop())}),a.addEventListener("mouseleave",function(){currentItemHovered=null})}else{var o=document.createElement("div");o.classList.add("voxels-task-name","js-voxels-task-name-reload-state");var g=e.finished,h=Date.now(),C=Math.floor((h-g)/1e3);if(void 0===e.finished||C>300)o.innerHTML='<div class="voxels-task-name-text">Visit task board to reload..</div>',a.appendChild(o);else{var o=document.createElement("div");o.classList.add("voxels-task-name","js-voxels-task-name-reload-state");var g=e.finished,h=Date.now(),C=Math.floor((h-g)/1e3);if(C>taskTimerSec)o.innerHTML='<div class="voxels-task-name-text">Visit task board to reload..</div>',a.appendChild(o);else{var T=taskTimerSec-C,L=Math.floor(T/60),$=T%60;o.innerHTML='<div class="voxels-task-name-text">'+(L+":")+($<10?"0":"")+$+"</div>",a.appendChild(o);var q=setInterval(function(){var e=Math.floor(--T/60),t=T%60;o.innerHTML='<div class="voxels-task-name-text">'+(e+":")+(t<10?"0":"")+t+"</div>",T<=0&&(clearInterval(q),o.innerHTML='<div class="voxels-task-name-text">Visit task board to reload..</div>')},1e3)}}}t.appendChild(a)}),currentTasksElements=t,t}function checkTasks(){compareTasks().then(e=>{e&&chrome.storage.local.get("task_data",function(e){currentTasks=getCurrentTasks(e),chrome.storage.local.set({task_data:currentTasks}),"tasks"===currentActiveTab&&premium&&loadTaskPage(currentTasks),setTaskData(currentTasks).then(e=>{if("success"===e)return})})}).catch(e=>{console.log("Error comparing tasks:",e)})}function compareTasks(){return new Promise((e,t)=>{chrome.storage.local.get("task_data",function(t){if(t.task_data){let a=getCurrentTasks(0),s=t.task_data;a.length!==s.length&&e(!0);for(let i=0;i<a.length;i++)compareTaskObjects(a[i],s[i])||e(!0);e(!1)}else e(!0)})})}function compareTaskObjects(e,t){return e.name===t.name&&e.quantity===t.quantity&&e.position===t.position&&e.rewardCurrency===t.rewardCurrency&&e.rewardAmount===t.rewardAmount&&e.type===t.type&&e.skillType===t.skillType}function setTaskData(e){return new Promise(async(t,a)=>{chrome.storage.local.get("pid",async function(s){let i=s.pid;try{let n=await makeFetchRequest(apiURL,{pid:i,operation:"saveTasks",extra:e});t(n.data)}catch(l){a(l)}})})}function getCurrentTasks(e){let t=document.querySelectorAll(nodeNames.tasksCard);if(t.length>0){let a=[];if(t.forEach((e,t)=>{if(!e.classList.contains(nodeNames.tasksTitle)){let s=e.querySelector(nodeNames.tasksTitle);if(s){let i=s.innerText,n,l,r,o,d="";if("NEW TASK IN:"===i)i="Loading...";else if("vip"===i)i="VIP";else{let c=e.querySelectorAll(nodeNames.tasksCostDisplay);if(c.length>1){let v=c[1],p=v.querySelector(nodeNames.tasksCostImage);p&&(n=p.src);let u=v.querySelector(nodeNames.tasksCost);u&&(l=u.innerText)}}let k=e.querySelector(nodeNames.tasksImage),m=k?k.src:"https://pixels-api.com/images/item_not_found.png",y=e.querySelector(nodeNames.tasksQuantity),x=y?parseInt(y.innerText,10):1,f="Basic",g=e.querySelector(nodeNames.tasksWrapper);g&&(g.classList.contains(nodeNames.tasksVIP)?f="VIP":g.classList.contains(nodeNames.tasksLandowner)&&(f="Landowner")),e.querySelector(nodeNames.taskTier)&&(r=e.querySelector(nodeNames.taskTier).textContent);let h=currentTasksData.find(e=>e.position===t&&e.name===i&&e.quantity===x&&e.type===f);h&&(n=h.rewardCurrency,o=h.skillType,d=h.skillXp);let C={name:i,quantity:x,image:m,rewardCurrency:n,rewardAmount:l,position:t,type:f,tier:r,skillType:o,skillXp:d};if("Loading..."===i){let T=currentTasks.find(e=>e.position===t);T&&"Loading..."===T.name?C.finished=T.finished:C.finished=Date.now()}let L=e.querySelector("button");!L||L.disabled||L.hasAttribute("data-listener-attached")||(L.addEventListener("click",function(){deliverTask(C)}),L.setAttribute("data-listener-attached","true")),a.push(C)}}}),a.length>0)return a}}function deliverTask(e){let t=currentTasksData.find(t=>t.position===e.position&&t.name===e.name&&t.quantity===e.quantity&&t.type===e.type);t&&(e.rewardCurrency=t.rewardCurrency,e.rewardAmount=t.rewardAmount,e.skillType=t.skillType,e.skillXp=t.skillXp),chrome.storage.local.get("deliveredTasks",function(t){let a=t.deliveredTasks||[],s=Date.now();a=a.filter(e=>s-e.timestamp<=36e5);let i=a.some(t=>t.position===e.position&&t.name===e.name&&t.quantity===e.quantity&&t.type===e.type&&t.rewardAmount===e.rewardAmount&&s-t.timestamp<=12e5);i||(a.push({...e,timestamp:s}),chrome.storage.local.set({deliveredTasks:a}),chrome.storage.local.get("pid",async function(t){let a=t.pid;try{await makeFetchRequestByPID(apiURL,{pid:a,operation:"deliverTask",extra:e})}catch(s){console.error("Error delivering task:",s)}}))})}function setTasksCost(){"tasks"==currentActiveTab&&chrome.storage.local.get("task_data",async function(e){let t=e.task_data.map(e=>e.name);loadTasksCost(t).then(e=>{e.forEach((e,t)=>{let a=currentTasksElements.querySelector(`.voxels-task-item:nth-child(${t+1})`);if(a&&null!==e.price){let s=a.querySelector(".voxels-task-main-quantity"),i=s?parseInt(s.textContent,10):1;var n=parseInt(e.price,10)*i;let l=a.querySelector(".voxels-task-cost-container");if(!l)return;let r=l.querySelector(".voxels-task-cost");r||((r=document.createElement("div")).classList.add("voxels-task-cost"),l.appendChild(r));let o=r.querySelector("img");o||((o=document.createElement("img")).classList.add("voxels-task-cost-icon"),r.appendChild(o)),o.src=chrome.runtime.getURL("/images/Prices/coin.png");let d=r.querySelector(".voxels-task-cost-amount");d||((d=document.createElement("div")).classList.add("voxels-task-cost-amount"),r.appendChild(d)),d.textContent=nFormatter(Math.abs(n),1);let c=currentTasksData.find(e=>e.position===t&&e.quantity===i);if(c){if(c.rewardCurrency.includes("coins")){let v=parseFormattedAmount(c.rewardAmount)-parseInt(e.price,10)*i,p=a.querySelector(".voxels-task-total");p||((p=document.createElement("div")).classList.add("voxels-task-total"),a.appendChild(p)),p.innerHTML="";let u=document.createElement("img");u.classList.add("voxels-task-cost-icon"),u.src=chrome.runtime.getURL("/images/Prices/coin.png"),p.appendChild(u);let k=document.createElement("span");k.classList.add("voxels-task-total-amount"),k.textContent=nFormatter(Math.abs(v),1),p.appendChild(k),v<0?k.classList.add("voxels-task-total-negative"):k.classList.add("voxels-task-total-positive")}else if(c.rewardCurrency.includes("cur_pixel")){let m=parseInt(e.price,10)*i/c.rewardAmount,y=a.querySelector(".voxels-task-total");y||((y=document.createElement("div")).classList.add("voxels-task-total"),a.appendChild(y)),y.innerHTML="";let x=document.createElement("span");x.textContent="C/P = ",y.appendChild(x);let f=document.createElement("span");f.classList.add("voxels-task-total-amount"),f.textContent=nFormatter(m,2),y.appendChild(f)}}}else if("Loading..."!==e.name){let g=a.querySelector(".voxels-task-total");g||((g=document.createElement("div")).classList.add("voxels-task-total"),a.appendChild(g)),g.innerHTML="",g.textContent="N/A"}})}).catch(e=>{console.error(e)})})}function loadTasksCost(e){return new Promise(async(t,a)=>{chrome.storage.local.get("user_info",async function(s){let i={name:s.user_info,operation:"fetchPricesByName",extra:e};try{let n=await makeFetchRequest(apiURL,i),l=n.data,r=e.map(e=>({name:e,price:l[e]}));t(r)}catch(o){a(o)}})})}function addTaskQuantities(){if(currentInventory&&currentInventory.items){let e=new Map;for(let t of currentInventory.items){let a=displayNamesJSONArray.find(e=>e.item===t.item),s=a?a.display_name:t.item;e.has(s)?e.get(s).quantity+=t.quantity:e.set(s,{display_name:s,quantity:t.quantity})}let i=Array.from(e.values()),n=document.querySelectorAll(".voxels-task-item");n.forEach(e=>{if(e.querySelector(".js-voxels-task-name-reload-state"))return;let t=e.querySelector(".voxels-task-name").textContent,a=i.find(e=>e.display_name===t),s=a?a.quantity:0,n=e.querySelector(".voxels-task-main-quantity").textContent,l=e.querySelector(".voxels-task-quantity-container");if(l){let r=l.querySelector(".voxels-task-quantity:first-child");r&&(r.textContent=s)}else(l=document.createElement("div")).className="voxels-task-quantity-container",l.innerHTML=`<div class="voxels-task-quantity">${s}</div>/<div class="voxels-task-quantity voxels-task-main-quantity">${n}</div>`,e.querySelector(".voxels-task-quantity").replaceWith(l);s>=n?e.classList.add("voxels-task-achievable"):e.classList.remove("voxels-task-achievable")})}}window.addEventListener("message",function(e){e.data&&"VOXELS_TASK_DATA"===e.data.type&&(currentTasksData=e.data.value)},!1);