var currentTasksElements,currentTasksData=[],currentTasks=[],setInitialData=!1;function loadTasks(e){chrome.storage.local.get("task_data",(function(e){e.task_data?loadTaskPage(e.task_data):loadTaskPage(!1)}))}async function loadTaskPage(e){const t=document.querySelector(".voxels-main");if(!1===e){const e=document.createElement("div");e.classList.add("voxels-main-tasks"),t.appendChild(e);const a=document.createElement("div");a.textContent="Open the tasks to start.",e.appendChild(a)}else await displayTaskStats(t,e),t.appendChild(createTaskContainer(e)),setInitialData||(setInitialData=!0,currentTasksData=e),setTasksCost(),addTaskQuantities()}function displayTaskStats(e,t){return new Promise((a=>{chrome.storage.local.get("deliveredTasks",(function(s){reloadOverlay();const n=s.deliveredTasks||[],o=Date.now(),i=n.filter((e=>o-e.timestamp<=36e5)).length;let r=document.querySelector(".task-stats");r||(r=document.createElement("div"),r.classList.add("voxels-task-pace"),e.insertBefore(r,e.firstChild));let l=0;t.forEach((e=>{const t=getItmByName(e.name),a=loadItemData(t);a&&"number"==typeof a.price&&(l+=e.quantity*a.price)}));const c=nFormatter(l,1),d=document.createElement("div");d.classList.add("voxels-task-pace-cell");const m=document.createElement("div");m.classList.add("voxels-task-pace-cell-data");const p=document.createElement("img");p.src=chrome.runtime.getURL("/images/Prices/coin.png"),m.appendChild(p),m.appendChild(document.createTextNode(c));const u=document.createElement("div");u.classList.add("voxels-task-pace-cell-info"),u.textContent="Total:",d.appendChild(u),d.appendChild(m);const v=document.createElement("div");v.classList.add("voxels-task-pace-cell");const k=document.createElement("div");k.classList.add("voxels-task-pace-cell-data");const h=()=>{const e=new Date,t=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate()+1,0,0,0))-e,a=String(Math.floor(t/36e5%24)).padStart(2,"0"),s=String(Math.floor(t/6e4%60)).padStart(2,"0"),n=String(Math.floor(t/1e3%60)).padStart(2,"0");k.textContent=`${a}:${s}:${n}`};setInterval(h,1e3),h(),v.appendChild(k);const y=document.createElement("div");y.classList.add("voxels-task-pace-cell");const x=document.createElement("div");x.classList.add("voxels-task-pace-cell-data"),x.textContent=i.toFixed(2);const f=document.createElement("div");f.classList.add("voxels-task-pace-cell-info"),f.textContent="t/h",y.appendChild(x),y.appendChild(f),r.innerHTML="",r.appendChild(d),r.appendChild(v),r.appendChild(y),a()}))}))}function createTaskContainer(e){var t=document.createElement("div");return!0===taskboardTiles?t.classList.add("voxels-task-items-container","js-minimal-styling"):t.classList.add("voxels-task-items-container"),e.forEach((e=>{var a=document.createElement("div");a.classList.add("voxels-task-item","clickable");var s=document.createElement("div");s.classList.add("voxels-task-item-primary"),a.appendChild(s);var n=document.createElement("div");n.classList.add("voxels-task-item-visual"),s.appendChild(n);var o=document.createElement("img");const i=displayNamesJSONArray.find((t=>t.display_name===e.name));o.src=i?i.image:e.image,n.appendChild(o);var r=document.createElement("div");if(r.classList.add("voxels-task-item-visual-tier"),r.textContent=e.tier,n.appendChild(r),"VIP"==e.name)a.classList.add("voxels-task-ready"),(y=document.createElement("div")).classList.add("voxels-task-name","js-voxels-task-name-reload-state"),y.innerHTML=e.name,a.appendChild(y);else if("Loading..."!==e.name){a.classList.add("voxels-task-ready");var l=document.createElement("div");l.classList.add("voxels-task-quantity","voxels-task-main-quantity"),l.textContent=e.quantity,s.appendChild(l),(y=document.createElement("p")).classList.add("voxels-task-name"),y.setAttribute("id","voxels-copy"),y.setAttribute("translate","no"),y.innerHTML='<div class="voxels-task-name-text">'+e.name+"</div><img src='"+chrome.runtime.getURL("images/icons/icon__copy.svg")+"' alt='Copy Icon'>",a.appendChild(y);var c=getItmByName(e.name);const t=loadItemData(c),n=document.createElement("div");if(n.classList.add("voxels-task-info-wrapper"),e.skillType&&e.skillXp&&"N/A"!==e.skillType){const t=document.createElement("div");t.classList.add("voxels-task-skill");const a="https://d31ss916pli4td.cloudfront.net/game/ui/skills/skills_icon_"+e.skillType.toLowerCase()+".png?v2",s=document.createElement("img");s.src=a,s.alt=e.skillType+" icon",s.classList.add("voxels-task-skill-image"),t.appendChild(s);const o=document.createElement("span");o.classList.add("voxels-task-skill-xp"),o.textContent=nFormatter(e.skillXp,1),t.appendChild(o),n.appendChild(t)}if(premium&&"string"==typeof c){let t=0;for(const e in storedItemCache)if(storedItemCache.hasOwnProperty(e)){const a=storedItemCache[e];for(const e in a)if(a.hasOwnProperty(e)){const s=a[e];if(s.items&&Array.isArray(s.items))for(const e of s.items)e.item===c&&(t+=e.count)}}if(t>=e.quantity){const e=document.createElement("img");e.classList.add("voxels-task-in-storage"),e.src=chrome.runtime.getURL("images/icons/icon__in-storage.svg"),e.alt="storage",n.appendChild(e)}}a.appendChild(n);var d=document.createElement("div");d.classList.add("voxels-task-cost-container");var m=document.createElement("div");m.classList.add("voxels-task-reward");var p=document.createElement("img");p.classList.add("voxels-task-cost-icon"),"string"==typeof e.rewardCurrency?e.rewardCurrency.includes("coins")?p.src=chrome.runtime.getURL("/images/Prices/coin.png"):e.rewardCurrency.includes("cur_pixel")?p.src=chrome.runtime.getURL("/images/Other/Pixel.png"):p.src=e.rewardCurrency:p.src=chrome.runtime.getURL("/images/Prices/coin.png"),m.appendChild(p);var u=document.createElement("div");u.classList.add("voxels-task-reward"),u.textContent=e.rewardAmount,m.appendChild(u),d.appendChild(m),a.appendChild(d),"VIP"!==e.type&&"Landowner"!==e.type||("VIP"===e.type?a.classList.add("vip"):"Landowner"===e.type&&a.classList.add("landowner")),a.addEventListener("click",(function(t){if(premium&&t.shiftKey)changeTab("networth",e.name);else{var a=document.createElement("textarea");a.value=e.name,document.body.appendChild(a),a.select(),document.execCommand("copy"),document.body.removeChild(a);var s=document.querySelector(nodeNames.market_search);if(s)setNativeInputValue(s,e.name);else{var n=document.createElement("div");n.classList.add("voxels-hover-box"),n.textContent="Copied!",document.body.appendChild(n);var o=y.getBoundingClientRect();n.style.position="absolute",n.style.top=o.top-n.offsetHeight+"px",n.style.left=o.left+"px",setTimeout((function(){document.body.removeChild(n)}),2e3)}}})),a.addEventListener("mouseenter",(()=>{const s=document.createElement("div");s.classList.add("voxels-ms-hover");const n=document.createElement("div");n.classList.add("voxels-ms-hover-name"),n.textContent=t.displayName;const o=e.quantity*t.price,i=nFormatter(o,1),r=nFormatter(t.price,1),l=document.createElement("div");l.classList.add("voxels-ms-hover-price"),l.innerHTML=`${e.quantity} x ${r} = ${i}`;const d=document.createElement("img");if(d.src=chrome.runtime.getURL("images/Prices/coin.png"),d.classList.add("voxels-ms-price-icon"),l.innerHTML=`${e.quantity} x `,l.appendChild(d),l.innerHTML+=` ${r} = `,l.appendChild(d.cloneNode()),l.innerHTML+=` ${i}`,s.appendChild(n),s.appendChild(l),premium){storageCount=0;for(const e in storedItemCache)if(storedItemCache.hasOwnProperty(e)){const t=storedItemCache[e];for(const e in t)if(t.hasOwnProperty(e)){const a=t[e];if(a.items&&Array.isArray(a.items))for(const e of a.items)e.item===c&&(storageCount+=e.count)}}const e=document.createElement("div");e.classList.add("voxels-ms-hover-storage"),e.innerHTML=`<span>Storage:</span> ${storageCount} <span>(Shift + Click to Search)</span>`,s.appendChild(e)}const m=findRecipe(c);if(null!==m){const e=createRecipeContainer(m);s.appendChild(e)}const p=historic_item_prices(c);if(p){const e=document.createElement("div");e.classList.add("voxels-networth-hover-graph-container");const t=document.createElement("div");t.classList.add("voxels-networth-hover-graph-header"),t.textContent="7-day Graph",e.appendChild(t);let a=[...p];if(marketPrices[c]){const e=marketPrices[c],t=Math.floor(Date.now()/1e3);a.push({t:t,p:e})}const n=renderPriceChart(a);e.appendChild(n),s.appendChild(e)}document.body.appendChild(s);const u=a.getBoundingClientRect(),v=s.offsetWidth,k=s.offsetHeight;let h=u.left+u.width/2-v/2,y=u.top-k-5;const x=window.innerWidth;h<0&&(h=5),h+v>x&&(h=x-v),y<0&&(y=5),s.style.position="absolute",s.style.left=`${h}px`,s.style.top=`${y}px`,premium&&(currentItemHovered=c,itemHoverLoop())})),a.addEventListener("mouseleave",(()=>{document.querySelectorAll(".voxels-ms-hover").forEach((e=>{e.parentNode&&e.parentNode.removeChild(e)})),premium&&(currentItemHovered=null)}))}else{(y=document.createElement("div")).classList.add("voxels-task-name","js-voxels-task-name-reload-state");var v=e.finished,k=Date.now(),h=Math.floor((k-v)/1e3);if(void 0===e.finished||h>300)y.innerHTML='<div class="voxels-task-name-text">Visit task board to reload..</div>',a.appendChild(y);else{var y;(y=document.createElement("div")).classList.add("voxels-task-name","js-voxels-task-name-reload-state");v=e.finished,k=Date.now();if((h=Math.floor((k-v)/1e3))>taskTimerSec)y.innerHTML='<div class="voxels-task-name-text">Visit task board to reload..</div>',a.appendChild(y);else{var x=taskTimerSec-h,f=Math.floor(x/60),C=x%60,g=f+":"+(C<10?"0":"")+C;y.innerHTML='<div class="voxels-task-name-text">'+g+"</div>",a.appendChild(y);var L=setInterval((function(){x--;var e=Math.floor(x/60),t=x%60,a=e+":"+(t<10?"0":"")+t;y.innerHTML='<div class="voxels-task-name-text">'+a+"</div>",x<=0&&(clearInterval(L),y.innerHTML='<div class="voxels-task-name-text">Visit task board to reload..</div>')}),1e3)}}}t.appendChild(a)})),currentTasksElements=t,t}function checkTasks(){compareTasks().then((e=>{e&&chrome.storage.local.get("task_data",(function(e){currentTasks=getCurrentTasks(e),chrome.storage.local.set({task_data:currentTasks}),"tasks"===currentActiveTab&&loadTaskPage(currentTasks),setTaskData(currentTasks).then((e=>{}))}))})).catch((e=>{}))}function compareTasks(){return new Promise(((e,t)=>{chrome.storage.local.get("task_data",(function(t){if(t.task_data){const a=getCurrentTasks(0),s=t.task_data;a.length!==s.length&&e(!0);for(let t=0;t<a.length;t++)compareTaskObjects(a[t],s[t])||e(!0);e(!1)}else e(!0)}))}))}function compareTaskObjects(e,t){return e.name===t.name&&e.quantity===t.quantity&&e.position===t.position&&e.rewardCurrency===t.rewardCurrency&&e.rewardAmount===t.rewardAmount&&e.type===t.type&&e.skillType===t.skillType}function setTaskData(e){return new Promise((async(t,a)=>{chrome.storage.local.get("pid",(async function(s){const n={pid:s.pid,operation:"saveTasks",extra:e};try{const e=await makeFetchRequest(apiURL,n);t(e.data)}catch(e){a(e)}}))}))}function getCurrentTasks(e){const t=document.querySelectorAll(nodeNames.tasksCard);if(t.length>0){const e=[];if(t.forEach(((t,a)=>{if(!t.classList.contains(nodeNames.tasksTitle)){const s=t.querySelector(nodeNames.tasksTitle);if(s){let n,o,i,r,l=s.innerText,c="";if("NEW TASK IN:"===l)l="Loading...";else if("vip"===l)l="VIP";else{const e=t.querySelectorAll(nodeNames.tasksCostDisplay);if(e.length>1){const t=e[1],a=t.querySelector(nodeNames.tasksCostImage);a&&(n=a.src);const s=t.querySelector(nodeNames.tasksCost);s&&(o=s.innerText)}}const d=t.querySelector(nodeNames.tasksImage),m=d?d.src:"https://pixels-api.com/images/item_not_found.png",p=t.querySelector(nodeNames.tasksQuantity),u=p?parseInt(p.innerText,10):1;let v="Basic";const k=t.querySelector(nodeNames.tasksWrapper);k&&(k.classList.contains(nodeNames.tasksVIP)?v="VIP":k.classList.contains(nodeNames.tasksLandowner)&&(v="Landowner")),t.querySelector(nodeNames.taskTier)&&(i=t.querySelector(nodeNames.taskTier).textContent);const h=currentTasksData.find((e=>e.position===a&&e.name===l&&e.quantity===u&&e.type===v));h&&(n=h.rewardCurrency,r=h.skillType,c=h.skillXp);const y={name:l,quantity:u,image:m,rewardCurrency:n,rewardAmount:o,position:a,type:v,tier:i,skillType:r,skillXp:c};if("Loading..."===l){const e=currentTasks.find((e=>e.position===a));e&&"Loading..."===e.name?y.finished=e.finished:y.finished=Date.now()}const x=t.querySelector("button");!x||x.disabled||x.hasAttribute("data-listener-attached")||(x.addEventListener("click",(function(){deliverTask(y)})),x.setAttribute("data-listener-attached","true")),e.push(y)}}})),e.length>0)return e}}function deliverTask(e){const t=currentTasksData.find((t=>t.position===e.position&&t.name===e.name&&t.quantity===e.quantity&&t.type===e.type));t&&(e.rewardCurrency=t.rewardCurrency,e.rewardAmount=t.rewardAmount,e.skillType=t.skillType,e.skillXp=t.skillXp),chrome.storage.local.get("deliveredTasks",(function(t){let a=t.deliveredTasks||[];const s=Date.now();a=a.filter((e=>s-e.timestamp<=36e5));a.some((t=>t.position===e.position&&t.name===e.name&&t.quantity===e.quantity&&t.type===e.type&&t.rewardAmount===e.rewardAmount&&s-t.timestamp<=12e5))||(a.push({...e,timestamp:s}),chrome.storage.local.set({deliveredTasks:a}),chrome.storage.local.get("pid",(async function(t){const a={pid:t.pid,operation:"deliverTask",extra:e};try{await makeFetchRequestByPID(apiURL,a)}catch(e){}})))}))}function setTasksCost(){if("tasks"==currentActiveTab){currentTasksElements.querySelectorAll(".voxels-task-item").forEach(((e,t)=>{const a=e.querySelector(".voxels-task-name-text").textContent,s=getItmByName(a);if(e&&null!==s){const a=e.querySelector(".voxels-task-main-quantity"),o=a?parseInt(a.textContent,10):1,i=marketPrices[s];if("number"!=typeof i||isNaN(i))return;var n=parseInt(i,10)*o;let r=e.querySelector(".voxels-task-cost-container");if(!r)return;let l=r.querySelector(".voxels-task-cost");l||(l=document.createElement("div"),l.classList.add("voxels-task-cost"),r.appendChild(l));let c=l.querySelector("img");c||(c=document.createElement("img"),c.classList.add("voxels-task-cost-icon"),l.appendChild(c)),c.src=chrome.runtime.getURL("/images/Prices/coin.png");let d=l.querySelector(".voxels-task-cost-amount");d||(d=document.createElement("div"),d.classList.add("voxels-task-cost-amount"),l.appendChild(d)),d.textContent=nFormatter(Math.abs(n));const m=currentTasksData.find((e=>e.position===t&&e.quantity===o));if(m)if(m.rewardCurrency.includes("coins")){let t=parseFormattedAmount(m.rewardAmount)-parseInt(i,10)*o,a=e.querySelector(".voxels-task-total");a||(a=document.createElement("div"),a.classList.add("voxels-task-total"),e.appendChild(a)),a.innerHTML="";let s=document.createElement("img");s.classList.add("voxels-task-cost-icon"),s.src=chrome.runtime.getURL("/images/Prices/coin.png"),a.appendChild(s);let n=document.createElement("span");n.classList.add("voxels-task-total-amount"),n.textContent=nFormatter(Math.abs(t),1),a.appendChild(n),t<0?n.classList.add("voxels-task-total-negative"):n.classList.add("voxels-task-total-positive")}else if(m.rewardCurrency.includes("cur_pixel")){let t=parseInt(i,10)*o/m.rewardAmount,a=e.querySelector(".voxels-task-total");a||(a=document.createElement("div"),a.classList.add("voxels-task-total"),e.appendChild(a)),a.innerHTML="";let s=document.createElement("span");s.textContent="C/P = ",a.appendChild(s);let n=document.createElement("span");n.classList.add("voxels-task-total-amount"),n.textContent=nFormatter(t,2),a.appendChild(n)}}}))}}function addTaskQuantities(){if(currentInventory&&currentInventory.items){const e=new Map;for(const t of currentInventory.items){const a=displayNamesJSONArray.find((e=>e.item===t.item)),s=a?a.display_name:t.item;e.has(s)?e.get(s).quantity+=t.quantity:e.set(s,{display_name:s,quantity:t.quantity})}const t=Array.from(e.values());document.querySelectorAll(".voxels-task-item").forEach((e=>{if(e.querySelector(".js-voxels-task-name-reload-state"))return;const a=e.querySelector(".voxels-task-name").textContent;let s=t.find((e=>e.display_name===a));const n=s?s.quantity:0,o=e.querySelector(".voxels-task-main-quantity").textContent;let i=e.querySelector(".voxels-task-quantity-container");if(i){const e=i.querySelector(".voxels-task-quantity:first-child");e&&(e.textContent=n)}else i=document.createElement("div"),i.className="voxels-task-quantity-container",i.innerHTML=`<div class="voxels-task-quantity">${n}</div>/<div class="voxels-task-quantity voxels-task-main-quantity">${o}</div>`,e.querySelector(".voxels-task-quantity").replaceWith(i);n>=o?e.classList.add("voxels-task-achievable"):e.classList.remove("voxels-task-achievable")}))}}window.addEventListener("message",(function(e){e.data&&"VOXELS_TASK_DATA"===e.data.type&&(currentTasksData=e.data.value,checkTasks())}),!1);