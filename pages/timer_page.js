let countdownIntervalId=null,lastSyncedTimestamp=0;function handleInitialTimerData(e){chrome.storage.local.get("timers_local",(function(t){const a=t.timers_local;0===e||a&&a.timestamp&&!(a.timestamp<e)?(lastSyncedTimestamp=a?.timestamp||0,loadTimers(0)):loadTimers(1)}))}function loadTimers(e){e?chrome.storage.local.get("pid",(async function(e){const t={pid:e.pid,operation:"fetchTimerData"};loadingScreen(1);try{const e=await makeFetchRequestByPID(apiURL,t);if(!handleErrors(e))if("logout"==e)initiate();else if(loadingScreen(0),e.data){const t={data:e.data.data||[],timestamp:e.data.timestamp||0};chrome.storage.local.set({timers_local:t},(function(){lastSyncedTimestamp=t.timestamp,loadTimerSections(t.data)}))}else loadTimerSections([])}catch(e){loadingScreen(0),quickMessage("Please try again.","error")}})):chrome.storage.local.get("timers_local",(function(e){loadTimerSections(e.timers_local?.data||[])}))}function loadTimerSections(e){const t=document.querySelector(".voxels-main");t.innerHTML="";let a=[];if(!e||0===e.length){const e=document.createElement("div");return e.textContent="Explore Pixels to automatically start tracking timers here.",e.className="voxels-timers-empty",void t.appendChild(e)}const s=["energy","producer","crafting","business","petcare"],n={energy:["energy"],producer:["farming","mining","forestry"],crafting:["woodwork","stoneshaping","metalworking","cooking"],business:["business"],petcare:["petcare"]},i={};for(const e of s)i[e]=n[e].map((e=>"energy"===e?"images/icons/icon_energy.png":`https://d31ss916pli4td.cloudfront.net/game/ui/skills/skills_icon_${e}.png`));const o={};e.forEach((e=>{o[e.class]||(o[e.class]=[]),o[e.class].push(e)})),s.forEach((e=>{if(o[e]){const s=document.createElement("div");s.className="voxels-timers-container";const l=document.createElement("div");l.className="voxels-timers-title-wrapper";const c=document.createElement("span");c.className="voxels-timers-title-text",c.textContent=e.charAt(0).toUpperCase()+e.slice(1),l.appendChild(c),(i[e]||[]).forEach((e=>{const t=document.createElement("img");t.className="voxels-timers-title-icon",t.src=e.startsWith("http")?e:chrome.runtime.getURL(e),l.appendChild(t)})),s.appendChild(l);if(!["energy","petcare","producer"].includes(e)){const t=document.createElement("img");t.className="voxels-timers-title-info-icon clickable",t.src=chrome.runtime.getURL("images/icons/icon__info.svg");const a=document.createElement("div");a.className="voxels-timers-title-xp-details",a.style.display="none",t.addEventListener("click",(()=>{"none"===a.style.display?(!function(){a.innerHTML="";const t=o[e]||[];for(const s of n[e]){let e=0;if(t.forEach((t=>{if(t.valueResolved){let a=null;if(t.valueResolved.startsWith("ach_")?a=findRecipeByAchievement(t.valueResolved):t.valueResolved.startsWith("itm_")&&(a=findRecipe(t.valueResolved)),a&&a.exp_type===s){const s=t.quantity||1;e+=a.exp*s}}})),e>0){const t="energy"===s?"images/icons/icon_energy.png":`https://d31ss916pli4td.cloudfront.net/game/ui/skills/skills_icon_${s}.png`,n=document.createElement("img");n.className="voxels-timers-title-xp-icon",n.src=t.startsWith("http")?t:chrome.runtime.getURL(t);const i=document.createElement("span");i.className="voxels-timers-title-xp-amount";const o=(new Intl.NumberFormat).format(e);i.textContent=`${s.charAt(0).toUpperCase()+s.slice(1)}: ${o} XP`;const l=document.createElement("div");l.className="voxels-timers-title-xp-skill",l.appendChild(n),l.appendChild(i),a.appendChild(l)}}a.hasChildNodes()||(a.textContent="No XP from current timers.")}(),a.style.display="flex"):a.style.display="none"})),l.appendChild(t),s.appendChild(a)}const r=document.createElement("div");r.className="voxels-timers-rows-container";const m=o[e].slice().sort(((e,t)=>(void 0!==e.timeResolved?e.timeResolved:1/0)-(void 0!==t.timeResolved?t.timeResolved:1/0))),d={};for(const e of m){const t=`${e.valueResolved||e.element_name}::${e.landId}`;d[t]||(d[t]=[]),d[t].push(e)}Object.values(d).forEach((e=>{const t=e.sort(((e,t)=>e.timeResolved-t.timeResolved))[0],s=e.length,n=document.createElement("div");n.className="voxels-timers-row";const i=document.createElement("div");i.className="voxels-timers-image-container";const o=document.createElement("img"),l="https://pixels-api.com/images/item_not_found.png",c=t.element_name,m=activeTimers[c];if(!m)return void removeTimer(t.key);const d=m?.image??null;let p,u=l,h=1,g="";if(m?.entityByItem&&t.valueResolved){if(g=t.valueResolved,g.startsWith("ach_")){const e=craftingRecipesJSONArray.find((e=>e.ach===g));e&&(g=e.item,h=e.quantity)}const e=loadItemData(g);u=e.imageSrc||l,p=e.displayName||g}else u=d?chrome.runtime.getURL(`images/${d}.png`):l,p=m?.display_name||c;const v=s>1?`<span class="voxels-timers-count">${s}x</span> ${p}`:p;if(o.src=u,o.alt=p,o.className="voxels-timers-img",i.appendChild(o),h>1){const e=document.createElement("div");e.classList.add("voxels-timers-img-quantity"),e.textContent=`x${h}`,i.appendChild(e)}["producer","crafting","business"].includes(t.class)&&null!=g&&""!==g&&(i.classList.add("clickable"),attachHoverDetails(i,g,h));const x=document.createElement("div");x.className="voxels-timers-info-container";const f=document.createElement("div");f.className="voxels-timers-left-compartment";const y=document.createElement("div");y.className="voxels-timers-top-left";const R=document.createElement("div");R.innerHTML=v,R.className="voxels-timers-name";const N=document.createElement("div");N.className="voxels-timers-location";let C=t.landId||"Unknown";C&&publicLands.hasOwnProperty(C)&&(C=publicLands[C]);let _=C;"SaunaInterior"===C?_="Sauna":C.startsWith("shareInterior")||C.startsWith("shareRent")?_="Speck":C.startsWith("nftHouse")?_=C.replace("nftHouse",""):C.startsWith("pixelsNFTFarm-")&&(_=C.replace("pixelsNFTFarm-",""));let T="images/icons/icon__location.svg";if(C.startsWith("nftHouse")||C.startsWith("House")||C.startsWith("shareInterior"))T="images/Other/house-1.png";else if(C.startsWith("pixelsNFTFarm-")||C.startsWith("shareRent")){T="images/pixels_icon.png";const e=t?.landType;"space"===e?T="images/Other/space_land.png":"water"===e&&(T="images/Other/water_land.png")}const E=document.createElement("img");E.src=chrome.runtime.getURL(T),E.alt="Location",E.className="voxels-timers-location-icon",N.appendChild(E),N.appendChild(document.createTextNode(_)),isNaN(_)||(N.classList.add("clickable"),N.addEventListener("click",(()=>{const e=document.querySelector(nodeNames.land_input);e&&setNativeInputValue(e,_)}))),y.appendChild(R),y.appendChild(N);const S=document.createElement("div");if(S.className="voxels-timers-bottom-left",!0===m?.displayValue){const e=document.createElement("div");e.className="voxels-timers-value";let a=t.valueResolved;if(null==a&&(a=m?.defaultValue??"N/A"),e.textContent=a,"energy"===m?.class){const t=document.createElement("img");t.src=chrome.runtime.getURL("images/icons/icon_energy.png"),t.alt="Energy",t.className="voxels-timers-value-icon",e.appendChild(t)}S.appendChild(e)}if("qs"===m?.displayExtra){const t=document.createElement("div");t.className="voxels-timers-extra";const s=document.createElement("img");s.src=chrome.runtime.getURL("images/Prices/voxels_qs.png"),s.alt="QS",s.className="voxels-timers-extra-icon";const n=document.createElement("div");n.className="voxels-timers-extra-amount",n.textContent="0",t.appendChild(s),t.appendChild(n),S.appendChild(t);const i=document.createElement("img");i.src=chrome.runtime.getURL("images/Other/Pixel.png"),i.alt="Pixel",i.className="voxels-timers-extra-icon",t.appendChild(i),a.push({text:n,extraDiv:t,entities:e,update(e){let t=0;if(this.entities.forEach((a=>{const s=a.timeResolved-e;s>0&&(t+=Math.ceil(s/6e4)*settings.qsExchange)})),t>0){const e=(t/settings.qsPixel).toFixed(2);this.text.textContent=t+" = ",i.style.display="inline-block",this.pixelAmountSpan||(this.pixelAmountSpan=document.createElement("span"),this.pixelAmountSpan.className="voxels-timers-extra-amount",this.extraDiv.appendChild(this.pixelAmountSpan)),this.pixelAmountSpan.textContent=e,this.extraDiv.style.display="flex"}else this.text.textContent="",i.style.display="none",this.pixelAmountSpan&&(this.pixelAmountSpan.textContent=""),this.extraDiv.style.display="none"},data:{imageSrc:u,locationText:_,rawName:p}})}if(s>1){const t=Math.max(...e.map((e=>e.timeResolved))),s=document.createElement("div");s.className="voxels-timers-last-timer",S.appendChild(s),a.push({text:s,endTime:t,update(e){const t=this.endTime-e;this.text.textContent=t<=0?"Ready":`${function(e){if(e<=0)return"Ready";const t=Math.floor(e/36e5),a=Math.floor(e%36e5/6e4),s=Math.floor(e%6e4/1e3);return`${String(t).padStart(2,"0")}:${String(a).padStart(2,"0")}:${String(s).padStart(2,"0")}`}(t)}`},data:{imageSrc:u,locationText:_,rawName:p}})}f.appendChild(y),f.appendChild(S);const k=document.createElement("div");k.className="voxels-timers-right-compartment";const w=document.createElement("img"),L=document.createElement("div");L.className="voxels-timers-time",w.className="voxels-timers-status-icon",k.appendChild(w),k.appendChild(L);const I=document.createElement("button");I.classList.add("voxels-timers-remove-btn","clickable"),I.innerHTML="âœ•",I.onclick=()=>{if(s>1){removeTimers(e.map((e=>e.key)))}else removeTimer(t.key)},k.appendChild(I);t.state===m.pauseState&&0===t.timeResolved?(w.src=chrome.runtime.getURL("images/icons/icon__setting.svg"),w.alt=m.pauseText||"Paused",L.textContent=m.pauseText||"Paused"):a.push({icon:w,text:L,endTime:t.timeResolved,data:{imageSrc:u,locationText:_,rawName:p}}),x.appendChild(f),x.appendChild(k),n.appendChild(i),n.appendChild(x),r.appendChild(n)})),s.appendChild(r),t.appendChild(s)}}));const l=new Set;function c(){const e=Date.now();a=a.filter((t=>{if(t.update)return t.update(e),!0;const a=t.endTime-e;if(a>0){const e=Math.floor(a/36e5),s=Math.floor(a%36e5/6e4),n=Math.floor(a%6e4/1e3);return t.text.textContent=`${String(e).padStart(2,"0")}:${String(s).padStart(2,"0")}:${String(n).padStart(2,"0")}`,t.icon.src=chrome.runtime.getURL("images/icons/icon__notready.svg"),t.icon.alt="Not Ready",notifications&&a<=31e3&&a>=29e3&&!l.has(t)&&(chrome.runtime.sendMessage({message:"show_notification",farmName:t.data?.rawName||"Unknown",location:t.data?.locationText||"Unknown",username:username,imageSrc:t.data?.imageSrc||null}),l.add(t)),!0}return t.text.textContent="Ready",t.icon.src=chrome.runtime.getURL("images/icons/icon__ready.svg"),t.icon.alt="Ready",!1}))}c(),null!==countdownIntervalId&&clearInterval(countdownIntervalId),countdownIntervalId=setInterval(c,1e3)}function removeTimers(e){chrome.storage.local.get({timers_local:{timestamp:0,data:[]}},(t=>{const a=t.timers_local.data.filter((t=>!e.includes(t.key))),s={timestamp:Date.now(),data:a};chrome.storage.local.set({timers_local:s},(()=>{loadTimers(0)}))}))}function removeTimer(e){chrome.storage.local.get({timers_local:{timestamp:0,data:[]}},(t=>{const a=t.timers_local.data.filter((t=>t.key!==e)),s={timestamp:Date.now(),data:a};chrome.storage.local.set({timers_local:s},(()=>{loadTimers(0)}))}))}async function updateTimers(e){if(!document.querySelector(nodeNames.hudTopLeft))return;await updateLocalTimers(e)&&"timers"===currentActiveTab&&loadTimers(0)}function updateLocalTimers(e){const t=e.timers,a=e.landId;return new Promise((e=>{chrome.storage.local.get({timers_local:{timestamp:0,data:[]}},(s=>{const n=s.timers_local.data;let i=!1;const o=[...n.filter((e=>e.landId!==a))];t.forEach((e=>{const t=activeTimers?.[e.element_name];if(t?.unique){const t=o.findIndex((t=>t.element_name===e.element_name));if(-1!==t){const a=o[t];a.timeResolved===e.timeResolved&&a.valueResolved===e.valueResolved&&a.state===e.state||(o[t]=e,i=!0)}else o.push(e),i=!0}else o.push(e)}));const l=n.filter((e=>e.landId===a)),c=o.filter((e=>e.landId===a));if(i||(i=l.length!==c.length||l.some((e=>!c.some((t=>t.key===e.key&&t.timeResolved===e.timeResolved&&t.valueResolved===e.valueResolved&&t.state===e.state))))),i){const t={timestamp:Date.now(),data:o};chrome.storage.local.set({timers_local:t},(()=>{e(!0)}))}else e(!1)}))}))}let timerRetryAttempts=0,hasBeenIngame=!1,gameDisconnect=!1;setInterval((()=>{if(timerRetryAttempts>3)return void quickMessage("Please reload Pixels, there's an error syncing your timers.","error");const e=document.querySelector(nodeNames.introLogo);if(gameDisconnect)return e?void 0:(chrome.storage.local.get(["pid","timers_local"],(async function(e){const t=e.pid,a=e.timers_local?.timestamp||0,s={pid:t,operation:"fetchTimerTimestamp"};try{const e=await makeFetchRequestByPID(apiURL,s);handleErrors(e)||(loadingScreen(0),"logout"==e?initiate():e.data&&Number(e.data)>Number(a)&&loadTimers(1))}catch(e){}})),void(gameDisconnect=!1));chrome.storage.local.get(["pid","timers_local"],(async({pid:e,timers_local:t})=>{if(!t||!t.data||0===t.data.length)return;const{timestamp:a,data:s}=t;if(a<=lastSyncedTimestamp)return;const n={pid:e,operation:"updateTimerData",extra:t};try{(await makeFetchRequestByPID(apiURL,n)).status&&(lastSyncedTimestamp=a,timerRetryAttempts=0)}catch(e){timerRetryAttempts++}}))}),5e3);