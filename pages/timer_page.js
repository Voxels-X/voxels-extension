let colorTimerStarted=!1,currentEnergy=1e3;function loadTimers(e){e?getUserData().then(e=>{!handleErrors(e)&&(loadFarmPage(e),premium&&setInterval(checkTimers,1e4))}).catch(e=>{console.log(e)}):chrome.storage.local.get("timer_data",function(e){loadFarmPage(e.timer_data)})}function loadFarmPage(e){let t=document.querySelector(".voxels-main");t.appendChild(addContent(e)).classList.add("active");let a=Object.keys(e).length;a<51&&(a>2?premium&&addNewButton():addNewButton()),premium||displayPremium(),colorTimerStarted||(colorTimerStarted=!0,setInterval(()=>{setTimersBG()},2e3)),t.appendChild(loadHelp())}function addContent(e){var t=document.createElement("div");return t.classList.add("voxels-main-page"),loadFilterTimers(t),loadFarms(t,e),t}function loadFilterTimers(e){var t=document.createElement("div");t.classList.add("voxels-filter-container");var a=document.createElement("input");a.setAttribute("type","text"),a.setAttribute("placeholder","Filter timers..."),a.classList.add("voxels-farm-filter-input"),t.appendChild(a);var r=document.createElement("div");r.classList.add("voxels-filter-dropdown-container");var n=document.createElement("button");n.classList.add("voxels-filter-dropdown-button","clickable");var o=document.createElement("img");o.src=chrome.runtime.getURL("images/icons/icon__filter.svg"),n.appendChild(o),r.appendChild(n);var i=document.createElement("div");i.classList.add("voxels-filter-dropdown-content"),i.style.display="none",r.appendChild(i);let l=["coop","apiary","hutch","mine","tree","stump","custom","nucyber_chip","nucyber_box","grumpkin","candy","post","sauna","cow","mill","kiln","winery","woodworking","textile_mill","barneys_barnbq","submarine_sizzler","galactic_grill","bluzzleberry","orange_grumpkin","blue_grumpkin","butterberry","clover","grainbow","javabean","watermint","scarrot","astracactus","hotato","muckchuck"];function s(){let t=a.value.toLowerCase(),r=Array.from(i.querySelectorAll('input[type="checkbox"]:checked')).map(e=>e.dataset.farmType),n=e.querySelectorAll(".voxels-main-grid");n.forEach(e=>{let a=e.querySelector(".voxels-main-title-text").textContent.toLowerCase(),n=Array.from(e.querySelectorAll(".voxels-main-farm-cell")),o=0===r.length||n.some(e=>r.some(t=>e.classList.contains("voxels-type-"+t))),i=""===t||a.includes(t);i&&o?e.style.display="":e.style.display="none"})}l.forEach(e=>{var t=document.createElement("label"),a=document.createElement("input");a.setAttribute("type","checkbox"),a.dataset.farmType=e;var r=document.createElement("img");r.src=chrome.runtime.getURL("images/Farms/voxels_"+e+".png"),r.alt=e+" image",r.classList.add("voxels-filter-farm-icon"),t.appendChild(a),t.appendChild(r),i.appendChild(t)}),n.onclick=function(){i.style.display="none"===i.style.display?"flex":"none"},t.appendChild(r),e.appendChild(t),a.addEventListener("keydown",function(e){setTimeout(s,10),e.stopPropagation()}),l.forEach(e=>{i.querySelector(`input[data-farm-type="${e}"]`).addEventListener("change",s)})}function loadFarms(e,t){let a={Farms:["coop","apiary","hutch","mine"],Industries:["mill","kiln","winery","woodworking","textile_mill","barneys_barnbq","submarine_sizzler","galactic_grill"],Trees:["tree","stump"],Other:[],Crops:["bluzzleberry","orange_grumpkin","blue_grumpkin","butterberry","clover","grainbow","javabean","watermint","scarrot","astracactus","hotato","muckchuck"]};function r(e,t){var a=document.createElement("div");a.classList.add("voxels-main-farm-icon");var r=document.createElement("img");r.classList.add("voxels-main-farm-image"),r.src=chrome.runtime.getURL("images")+"/Farms/voxels_"+e+".png",r.alt=e+" Image";var n=document.createElement("div");return n.classList.add("plus-icon"),n.textContent="+",a.appendChild(r),a.appendChild(n),a.addEventListener("click",function(){addFarm(t,e)}),a}for(let[n,o]of Object.entries(t)){let i=n.charAt(0).toUpperCase()+n.slice(1);var l=document.createElement("div");l.classList.add("voxels-main-grid"),l.classList.add("voxels-farm-"+n);var s=document.createElement("div");s.classList.add("voxels-main-title-text"),s.textContent=i,l.appendChild(s);let c=[];c="NuCyber"==n?["nucyber_chip","nucyber_box","custom"]:"terravilla"==n?["winery","kiln","textile_mill","woodworking","tree","stump","coop","apiary","hutch","mine","bluzzleberry","orange_grumpkin","blue_grumpkin","butterberry","clover","grainbow","javabean","scarrot","cow","custom"]:"collect"==n?["grumpkin","candy","post","sauna","custom"]:["mill","winery","kiln","textile_mill","woodworking","barneys_barnbq","submarine_sizzler","galactic_grill","tree","stump","coop","apiary","hutch","mine","blue_grumpkin","butterberry","clover","grainbow","javabean","watermint","scarrot","astracactus","hotato","muckchuck","custom"];let d=document.createElement("div");d.classList.add("voxels-farm-dropdown-container");let m=document.createElement("button");m.classList.add("voxels-farm-dropdown-button","clickable"),m.textContent="Add timer",d.appendChild(m);let u=document.createElement("div");u.classList.add("voxels-farm-dropdown-content"),u.style.display="none";let p={};c.forEach(e=>{let t=Object.keys(a).find(t=>a[t].includes(e));if(t||(t="Other",a.Other.push(e)),!p[t]){let r=document.createElement("div");r.classList.add("voxels-farm-section","voxels-farm-section-"+t.toLowerCase());let n=document.createElement("div");n.textContent=t,n.classList.add("voxels-farm-section-title"),r.appendChild(n),u.appendChild(r),p[t]=r}}),c.forEach(e=>{let t=p[Object.keys(a).find(t=>a[t].includes(e))||"Other"],o=r(e,n);t.appendChild(o)}),m.onclick=function(){u.style.display="none"===u.style.display?"flex":"none"},d.appendChild(u),l.appendChild(d);var f=document.createElement("div");f.classList.add("voxels-main-remove");var v=document.createElement("div");v.classList.add("voxels-remove-icon"),v.textContent="X",f.addEventListener("click",function(){removeLocation(n)}),f.appendChild(v),l.appendChild(f),loadFarmTypes(n,l,o),e.appendChild(l)}}function loadFarmTypes(e,t,a){let r=0,n=!1;for(let[o,i]of Object.entries(a)){var l=document.createElement("div");l.classList.add("voxels-main-farm-cell"),l.classList.add("voxels-type-"+o);var s=document.createElement("div");s.classList.add("voxels-remove-farm-icon"),s.textContent="âˆ’",s.addEventListener("click",function(){removeFarm(e,o)}),l.appendChild(s);var c=document.createElement("img");c.classList.add("voxels-main-farm-image"),c.src=chrome.runtime.getURL("images")+"/Farms/voxels_"+o+".png",c.alt="Image",l.appendChild(c);var d=createTimer(i);d.addEventListener("click",function(){startTimer(e,o)}),"Start"!==d.textContent&&(n=!0),l.appendChild(d),t.appendChild(l),r++}!0==n&&t.classList.add("voxels-main-grid-active")}function handleResult(e){handleErrors(e)||("logout"==e?initiate():(reloadOverlay(),loadTitleSection("timers"),chrome.storage.local.set({timer_data:e.data}),timersArray=e.data,loadTimers(0)))}function updateFarm(e,t,a,r){if("logout"==e)initiate();else{let n;switch(a){case"custom":case"mill":case"kiln":case"winery":case"woodworking":case"textile_mill":case"barneys_barnbq":case"submarine_sizzler":case"galactic_grill":case"blue_grumpkin":case"orange_grumpkin":n=Math.floor(Date.now()/1e3)+60*r;break;case"butterberry":n=Math.floor(Date.now()/1e3)+1200;break;case"apiary":case"clover":n=Math.floor(Date.now()/1e3)+2700;break;case"hutch":case"coop":case"grainbow":case"muckchuck":n=Math.floor(Date.now()/1e3)+3600;break;case"cow":n=Math.floor(Date.now()/1e3)+4800;break;case"mine":n=Math.floor(Date.now()/1e3)+5400;break;case"nucyber_box":case"nucyber_chip":case"watermint":case"bluzzleberry":n=Math.floor(Date.now()/1e3)+14400;break;case"javabean":case"hotato":n=Math.floor(Date.now()/1e3)+18e3;break;case"scarrot":case"sauna":n=Math.floor(Date.now()/1e3)+21600;break;case"astracactus":n=Math.floor(Date.now()/1e3)+25200;break;case"stump":n="terravilla"==t?Math.floor(Date.now()/1e3)+18e3:Math.floor(Date.now()/1e3)+9e3;break;case"tree":n="terravilla"==t?Math.floor(Date.now()/1e3)+52200:Math.floor(Date.now()/1e3)+26100;break;case"grumpkin":case"candy":case"post":n=Math.floor(Date.now()/1e3)+86400;break;default:console.error("Invalid farmType");return}let o=createTimer(n);o.addEventListener("click",function(){startTimer(t,a)});let i=`.voxels-farm-${t} .voxels-main-farm-cell.voxels-type-${a}`,l=document.querySelector(i),s=`.voxels-farm-${t}`,c=document.querySelector(s);if(c.classList.add("voxels-main-grid-active"),l){let d=l.querySelector(".voxels-main-timer");d&&l.removeChild(d),l.appendChild(o)}else{let m=Math.floor(new Date().getTime()/1e3);loadFarmTypes(t,c,{[a]:m}),i=`.voxels-farm-${t} .voxels-main-farm-cell.voxels-type-${a}`,l=document.querySelector(i);let u=l.querySelector(".voxels-main-timer");u&&l.removeChild(u),l.appendChild(o)}}}function removeLocation(e){chrome.storage.local.get("user_info",async function(t){let a=t.user_info;try{let r=await makeFetchRequest(apiURL,{name:a,operation:"removeLocation",extra:e});handleResult(r)}catch(n){console.error(n)}})}function addFarm(e,t){chrome.storage.local.get("user_info",async function(a){let r=a.user_info;try{let n=await makeFetchRequest(apiURL,{name:r,operation:"addFarm",extra:{[e]:t}});if(!handleErrors(n)){if("logout"==n)initiate();else{let o=`.voxels-farm-${e}`,i=document.querySelector(o),l=Math.floor(new Date().getTime()/1e3);chrome.storage.local.set({timer_data:n.data}),timersArray=n.data,loadFarmTypes(e,i,{[t]:l})}}}catch(s){console.error(s)}})}function removeFarm(e,t){chrome.storage.local.get("user_info",async function(a){let r=a.user_info;try{let n=await makeFetchRequest(apiURL,{name:r,operation:"removeFarm",extra:{[e]:t}});if(!handleErrors(n)){if("logout"==n)initiate();else{let o=`.voxels-farm-${e} .voxels-main-farm-cell.voxels-type-${t}`,i=document.querySelector(o);chrome.storage.local.set({timer_data:n.data}),timersArray=n.data,i.remove()}}}catch(l){console.error(l)}})}function startTimer(e,t){chrome.storage.local.get("user_info",async function(a){let r=a.user_info;if(["custom","mill","kiln","winery","woodworking","textile_mill","barneys_barnbq","submarine_sizzler","galactic_grill","blue_grumpkin","orange_grumpkin"].includes(t))inputWithCallback("Custom time in minutes:",function(a){if(/^\d+$/.test(a)&&2880>=parseInt(a)){let n={name:r,operation:"startTimer",extra:{[e]:t,time:parseInt(a)}};makeFetchRequest(apiURL,n).then(r=>{handleErrors(r)||("logout"==r?initiate():(updateFarm(r,e,t,a),chrome.storage.local.set({timer_data:r.data}),timersArray=r.data))}).catch(e=>{console.error(e)})}else showAlert("Please enter a valid time in minutes (not exceeding 48 hours).","error")});else try{let n=await makeFetchRequest(apiURL,{name:r,operation:"startTimer",extra:{[e]:t}});handleErrors(n)||("logout"==n?initiate():(updateFarm(n,e,t,0),chrome.storage.local.set({timer_data:n.data}),timersArray=n.data))}catch(o){console.error(o)}})}function startTimerType(e){chrome.storage.local.get("user_info",async function(t){let a=t.user_info,r="",n={name:a,operation:"updateTimer",extra:{[r]:e}};try{let o=await makeFetchRequest(apiURL,n);handleErrors(o)||("logout"==o?initiate():(chrome.storage.local.set({timer_data:o.data.timer_data}),timersArray=o.data.timer_data,r=o.data.location,"timers"===currentActiveTab&&updateFarm(o,r,e,0)))}catch(i){console.error(i)}})}function checkEnergyChange(){let e=nodeNames.energyText,t=document.querySelector(e);if(t){let a=t.textContent.trim().replace(/,/g,""),r=parseFloat(a);if(currentEnergy!==r){let n=r-currentEnergy;currentEnergy=r,n>450&&n<510&&startTimer("collect","sauna")}}}function addNewButton(){let e=document.querySelector(".voxels-main");var t=document.createElement("div");t.classList.add("voxels-main-new","pixel-border"),e.appendChild(t),t.innerHTML="Add current location",t.addEventListener("click",addButtonClick)}async function addButtonClick(){try{let e=await requestNewLocation();handleResult(e)}catch(t){console.error("Error:",t)}}async function requestNewLocation(){return new Promise((e,t)=>{chrome.storage.local.get("user_info",async function(a){let r=a.user_info;try{let n=await makeFetchRequest(apiURL,{name:r,operation:"add"});if("error"in n.data)e(n);else{let o=n.data;e(o.online?o:{error:"Error 1061"})}}catch(i){t(i)}})})}function createTimer(e){var t=document.createElement("div");function a(){let a=calculateTimeRemaining(e),n=formatTimeRemaining(a);t.textContent=n,a<=0?(clearInterval(r),t.textContent="Start",t.style.backgroundColor="green",t.classList.remove("timer-running")):(t.style.backgroundColor="#2c2c2c",t.classList.contains("timer-running")||t.classList.add("timer-running"))}t.classList.add("voxels-main-timer"),a();var r=setInterval(a,1e3);return t}function calculateTimeRemaining(e){let t=Math.floor(Date.now()/1e3);return Math.max(0,e-t)}function formatTimeRemaining(e){return`${padZero(Math.floor(e/3600))}:${padZero(Math.floor(e%3600/60))}:${padZero(e%60)}`}function padZero(e){return e<10?`0${e}`:`${e}`}function setTimersBG(){let e=document.querySelectorAll(".voxels-main-grid");e.forEach(e=>{let t=e.querySelector(".timer-running");t&&!e.classList.contains("voxels-main-grid-active")?e.classList.add("voxels-main-grid-active"):!t&&e.classList.contains("voxels-main-grid-active")&&e.classList.remove("voxels-main-grid-active")})}function checkTimers(){if(notifications){let e=Math.floor(Date.now()/1e3);Object.entries(timersArray).forEach(([t,a])=>{Object.entries(a).forEach(([a,r])=>{r-e>=30&&r-e<=39&&setTimeout(()=>{chrome.runtime.sendMessage({message:"show_notification",farmName:a,location:t,username:username})},1e3*(r-e-30))})})}}